{
    "sourceFile": "src/app/checkout/shipping/page.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 6,
            "patches": [
                {
                    "date": 1747800084344,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1747800096191,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,384 +1,1 @@\n-\"use client\";\r\n-\r\n-import { useState, useEffect } from \"react\";\r\n-import Link from \"next/link\";\r\n-import { useVietnameseAddress } from \"@/hooks/useVietnameseAddress\";\r\n-import OrderConfirmationModal from \"@/components/OrderConfirmationModal\";\r\n-\r\n-export default function ShippingPage({\r\n-  userEmail: propUserEmail,\r\n-  isShippingComplete,\r\n-  showAdditionalContact,\r\n-  showPaymentDetails,\r\n-  errors,\r\n-  handleShippingComplete,\r\n-  handleAdditionalContactToggle,\r\n-  order,\r\n-}) {\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [showPaymentSection, setShowPaymentSection] = useState(false);\r\n-  const [showConfirmationModal, setShowConfirmationModal] = useState(false);\r\n-  const [orderDetails, setOrderDetails] = useState(null);\r\n-  const [localUserEmail, setLocalUserEmail] = useState(\"\");\r\n-  const [formData, setFormData] = useState({\r\n-    firstName: \"\",\r\n-    lastName: \"\",\r\n-    address: \"\",\r\n-    phone: \"\",\r\n-    additionalPhone: \"\",\r\n-    apartment: \"\",\r\n-  });\r\n-\r\n-  const {\r\n-    provinces,\r\n-    districts,\r\n-    wards,\r\n-    selectedProvince,\r\n-    selectedDistrict,\r\n-    selectedWard,\r\n-    selectedProvinceName,\r\n-    selectedDistrictName,\r\n-    selectedWardName,\r\n-    handleProvinceChange,\r\n-    handleDistrictChange,\r\n-    handleWardChange\r\n-  } = useVietnameseAddress();\r\n-\r\n-  useEffect(() => {\r\n-    const email = localStorage.getItem('userEmail') || sessionStorage.getItem('userEmail');\r\n-    if (email) {\r\n-      setLocalUserEmail(email);\r\n-    }\r\n-  }, []);\r\n-\r\n-  const userEmail = propUserEmail || localUserEmail;\r\n-\r\n-  const handleInputChange = (e) => {\r\n-    const { name, value } = e.target;\r\n-    setFormData(prev => ({\r\n-      ...prev,\r\n-      [name]: value\r\n-    }));\r\n-  };\r\n-\r\n-  const handleContinueToPayment = (e) => {\r\n-    e.preventDefault();\r\n-    const shippingForm = document.getElementById('shippingForm');\r\n-    if (shippingForm.checkValidity()) {\r\n-      setShowPaymentSection(true);\r\n-      const paymentSection = document.getElementById('paymentSection');\r\n-      if (paymentSection) {\r\n-        paymentSection.scrollIntoView({ behavior: 'smooth' });\r\n-      }\r\n-    } else {\r\n-      shippingForm.reportValidity();\r\n-    }\r\n-  };\r\n-\r\n-  const handleCompleteOrder = async (e) => {\r\n-    e.preventDefault();\r\n-    \r\n-    try {\r\n-      if (!selectedProvince || !selectedDistrict || !selectedWard) {\r\n-        toast.error(\"Vui lòng chọn đầy đủ thông tin địa chỉ\");\r\n-        return;\r\n-      }\r\n-\r\n-      if (!formData.firstName || !formData.lastName || !formData.phone) {\r\n-        toast.error(\"Vui lòng điền đầy đủ thông tin bắt buộc\");\r\n-        return;\r\n-      }\r\n-\r\n-      const now = new Date();\r\n-      const orderCode = `AISH${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;\r\n-\r\n-      const subtotal = order.items.reduce((total, item) => {\r\n-        const priceStr = typeof item.price === 'string' ? item.price.replace('AU$', '').trim() : item.price;\r\n-        const price = parseFloat(priceStr) || 0;\r\n-        return total + (price * item.quantity);\r\n-      }, 0);\r\n-\r\n-      const details = {\r\n-        orderCode: orderCode,\r\n-        fullName: `${formData.firstName} ${formData.lastName}`,\r\n-        email: userEmail,\r\n-        phone: formData.phone,\r\n-        additionalPhone: formData.additionalPhone || null,\r\n-        apartment: formData.apartment || null,\r\n-        ward: selectedWardName || \"\",\r\n-        district: selectedDistrictName || \"\",\r\n-        province: selectedProvinceName || \"\",\r\n-        items: order.items.map(item => ({\r\n-          ...item,\r\n-          price: typeof item.price === 'string' ? parseFloat(item.price.replace('AU$', '').trim()) : item.price\r\n-        })),\r\n-        subtotal: subtotal,\r\n-        shippingFee: \"Free\",\r\n-        promoCode: order.promoCode || null,\r\n-        promoAmount: order.promoAmount || 0,\r\n-        total: subtotal - (order.promoAmount || 0),\r\n-        paymentMethod: paymentMethod,\r\n-        status: 'pending',\r\n-        paymentStatus: 'pending',\r\n-        shippingStatus: 'pending'\r\n-      };\r\n-\r\n-      setOrderDetails(details);\r\n-      setShowConfirmationModal(true);\r\n-    } catch (error) {\r\n-      console.error(\"Error preparing order:\", error);\r\n-      toast.error(\"Có lỗi xảy ra khi chuẩn bị đơn hàng. Vui lòng thử lại.\");\r\n-    }\r\n-  };\r\n-\r\n-  const handlePaymentMethodChange = (method) => {\r\n-    setPaymentMethod(method);\r\n-  };\r\n-\r\n-  const renderPaymentInfo = () => {\r\n-    if (!paymentMethod) return null;\r\n-\r\n-    if (paymentMethod === 'cod') {\r\n-      return (\r\n-        <div className=\"mt-5 p-4 bg-gray-50 rounded-md\">\r\n-          <p className=\"text-sm text-gray-600 italic\">\r\n-            Quý khách ghi nhớ mã đơn hàng và nhắn tin cho Facebook hoặc Instagram aish.aish.vn nếu muốn tra cứu mã vận đơn nhé\r\n-          </p>\r\n-        </div>\r\n-      );\r\n-    }\r\n-\r\n-    if (paymentMethod === 'bank') {\r\n-      return (\r\n-        <div className=\"mt-5 p-4 bg-gray-50 rounded-md\">\r\n-          <h3 className=\"text-sm font-semibold mb-3\">\r\n-            Thông tin chuyển khoản\r\n-          </h3>\r\n-          <div className=\"text-sm space-y-2\">\r\n-            <p>Ngân hàng: MB BANK</p>\r\n-            <p>Chủ tài khoản: PHAN THUY TRUC DAO</p>\r\n-            <p>Số tài khoản: 024052306</p>\r\n-            <p>Nội dung chuyển khoản: MÃ ĐƠN HÀNG + SĐT</p>\r\n-            <p className=\"mt-4 text-gray-600 italic\">\r\n-              Sau khi đặt hàng thành công, quý khách sẽ thấy mã đơn hàng tại trang. Quý khách vui lòng chuyển khoản đúng nội dung và chụp màn hình gửi về Facebook hoặc Instagram aish.aish.vn nhaa\r\n-            </p>\r\n-          </div>\r\n-        </div>\r\n-      );\r\n-    }\r\n-  };\r\n-\r\n-  return (\r\n-    <div className=\"flex-1 bg-white p-6 border border-gray-200\">\r\n-      <div className=\"mb-8\">\r\n-        <h2 className=\"text-lg font-semibold mb-3\">THÔNG TIN LIÊN HỆ</h2>\r\n-        <p className=\"text-sm\">\r\n-          {userEmail ? (\r\n-            <>\r\n-              {userEmail} (<Link href=\"/logout\" className=\"underline hover:text-gray-600\">Đăng xuất</Link>)\r\n-            </>\r\n-          ) : (\r\n-            \"Bạn chưa đăng nhập\"\r\n-          )}\r\n-        </p>\r\n-      </div>\r\n-\r\n-      <div className=\"mb-8\">\r\n-        <h2 className=\"text-lg font-semibold mb-3\">ĐỊA CHỈ GIAO HÀNG</h2>\r\n-        <form id=\"shippingForm\" className=\"space-y-4\">\r\n-          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n-            <div>\r\n-              <label className=\"block text-sm mb-1\">Tên *</label>\r\n-              <input\r\n-                name=\"firstName\"\r\n-                type=\"text\"\r\n-                value={formData.firstName}\r\n-                onChange={handleInputChange}\r\n-                className={`w-full px-3 py-2 border rounded-md ${errors.firstName ? 'border-red-500' : 'border-gray-300'}`}\r\n-                required\r\n-              />\r\n-            </div>\r\n-            <div>\r\n-              <label className=\"block text-sm mb-1\">Họ *</label>\r\n-              <input\r\n-                name=\"lastName\"\r\n-                type=\"text\"\r\n-                value={formData.lastName}\r\n-                onChange={handleInputChange}\r\n-                className={`w-full px-3 py-2 border rounded-md ${errors.lastName ? 'border-red-500' : 'border-gray-300'}`}\r\n-                required\r\n-              />\r\n-            </div>\r\n-          </div>\r\n-\r\n-          <div>\r\n-            <label className=\"block text-sm mb-1\">Số nhà, tên đường (tùy chọn)</label>\r\n-            <input\r\n-              name=\"apartment\"\r\n-              type=\"text\"\r\n-              value={formData.apartment}\r\n-              onChange={handleInputChange}\r\n-              className=\"w-full px-3 py-2 border border-gray-300 rounded-md\"\r\n-            />\r\n-          </div>\r\n-\r\n-          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n-            <div>\r\n-              <label className=\"block text-sm mb-1\">Tỉnh/Thành phố *</label>\r\n-              <select\r\n-                value={selectedProvince}\r\n-                onChange={handleProvinceChange}\r\n-                className={`w-full px-3 py-2 border rounded-md ${errors.province ? 'border-red-500' : 'border-gray-300'}`}\r\n-                required\r\n-              >\r\n-                <option value=\"\">Chọn Tỉnh/Thành phố</option>\r\n-                {provinces.map((province) => (\r\n-                  <option key={province.code} value={province.code}>\r\n-                    {province.name}\r\n-                  </option>\r\n-                ))}\r\n-              </select>\r\n-            </div>\r\n-            <div>\r\n-              <label className=\"block text-sm mb-1\">Quận/Huyện *</label>\r\n-              <select\r\n-                value={selectedDistrict}\r\n-                onChange={handleDistrictChange}\r\n-                className={`w-full px-3 py-2 border rounded-md ${errors.district ? 'border-red-500' : 'border-gray-300'}`}\r\n-                required\r\n-                disabled={!selectedProvince}\r\n-              >\r\n-                <option value=\"\">Chọn Quận/Huyện</option>\r\n-                {districts.map((district) => (\r\n-                  <option key={district.code} value={district.code}>\r\n-                    {district.name}\r\n-                  </option>\r\n-                ))}\r\n-              </select>\r\n-            </div>\r\n-          </div>\r\n-\r\n-          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n-            <div>\r\n-              <label className=\"block text-sm mb-1\">Phường/Xã *</label>\r\n-              <select\r\n-                value={selectedWard}\r\n-                onChange={handleWardChange}\r\n-                className={`w-full px-3 py-2 border rounded-md ${errors.ward ? 'border-red-500' : 'border-gray-300'}`}\r\n-                required\r\n-                disabled={!selectedDistrict}\r\n-              >\r\n-                <option value=\"\">Chọn Phường/Xã</option>\r\n-                {wards.map((ward) => (\r\n-                  <option key={ward.code} value={ward.code}>\r\n-                    {ward.name}\r\n-                  </option>\r\n-                ))}\r\n-              </select>\r\n-            </div>\r\n-            <div>\r\n-              <label className=\"block text-sm mb-1\">Số điện thoại *</label>\r\n-              <input\r\n-                name=\"phone\"\r\n-                type=\"tel\"\r\n-                value={formData.phone}\r\n-                onChange={handleInputChange}\r\n-                className={`w-full px-3 py-2 border rounded-md ${errors.phone ? 'border-red-500' : 'border-gray-300'}`}\r\n-                required\r\n-              />\r\n-            </div>\r\n-          </div>\r\n-\r\n-          {showAdditionalContact && (\r\n-            <div>\r\n-              <label className=\"block text-sm mb-1\">Số điện thoại phụ (tùy chọn)</label>\r\n-              <input\r\n-                name=\"additionalPhone\"\r\n-                type=\"tel\"\r\n-                value={formData.additionalPhone}\r\n-                onChange={handleInputChange}\r\n-                className=\"w-full px-3 py-2 border border-gray-300 rounded-md\"\r\n-              />\r\n-            </div>\r\n-          )}\r\n-\r\n-          <input type=\"hidden\" name=\"ward\" value={selectedWardName} />\r\n-          <input type=\"hidden\" name=\"district\" value={selectedDistrictName} />\r\n-          <input type=\"hidden\" name=\"province\" value={selectedProvinceName} />\r\n-\r\n-          <button\r\n-            onClick={handleContinueToPayment}\r\n-            className=\"w-full bg-black text-white py-3 px-4 rounded-md hover:bg-gray-800 transition-colors uppercase text-sm font-medium\"\r\n-            type=\"submit\"\r\n-          >\r\n-            Tiếp tục thanh toán\r\n-          </button>\r\n-        </form>\r\n-      </div>\r\n-\r\n-      {showPaymentSection && (\r\n-        <div id=\"paymentSection\" className=\"mb-8\">\r\n-          <h2 className=\"text-lg font-semibold mb-3\">PHƯƠNG THỨC THANH TOÁN</h2>\r\n-          <div className=\"space-y-4\">\r\n-            <div\r\n-              className={`p-4 border rounded-md cursor-pointer transition-colors ${\r\n-                paymentMethod === \"cod\" ? \"border-black\" : \"border-gray-300\"\r\n-              }`}\r\n-              onClick={() => handlePaymentMethodChange(\"cod\")}\r\n-            >\r\n-              <div className=\"flex items-center gap-3\">\r\n-                <input\r\n-                  type=\"radio\"\r\n-                  name=\"paymentMethod\"\r\n-                  checked={paymentMethod === \"cod\"}\r\n-                  onChange={() => handlePaymentMethodChange(\"cod\")}\r\n-                  className=\"w-4 h-4\"\r\n-                />\r\n-                <label className=\"text-sm font-medium\">\r\n-                  Thanh toán khi nhận hàng (COD)\r\n-                </label>\r\n-              </div>\r\n-            </div>\r\n-\r\n-            <div\r\n-              className={`p-4 border rounded-md cursor-pointer transition-colors ${\r\n-                paymentMethod === \"bank\" ? \"border-black\" : \"border-gray-300\"\r\n-              }`}\r\n-              onClick={() => handlePaymentMethodChange(\"bank\")}\r\n-            >\r\n-              <div className=\"flex items-center gap-3\">\r\n-                <input\r\n-                  type=\"radio\"\r\n-                  name=\"paymentMethod\"\r\n-                  checked={paymentMethod === \"bank\"}\r\n-                  onChange={() => handlePaymentMethodChange(\"bank\")}\r\n-                  className=\"w-4 h-4\"\r\n-                />\r\n-                <label className=\"text-sm font-medium\">\r\n-                  Chuyển khoản ngân hàng\r\n-                </label>\r\n-              </div>\r\n-            </div>\r\n-          </div>\r\n-\r\n-          {renderPaymentInfo()}\r\n-\r\n-          {paymentMethod && (\r\n-            <button\r\n-              onClick={handleCompleteOrder}\r\n-              className=\"w-full bg-black text-white py-3 px-4 rounded-md hover:bg-gray-800 transition-colors uppercase text-sm font-medium mt-6\"\r\n-            >\r\n-              Hoàn tất đơn hàng\r\n-            </button>\r\n-          )}\r\n-        </div>\r\n-      )}\r\n-\r\n-      <OrderConfirmationModal\r\n-        isOpen={showConfirmationModal}\r\n-        onClose={() => setShowConfirmationModal(false)}\r\n-        orderDetails={orderDetails}\r\n-      />\r\n-    </div>\r\n-  );\r\n-} \n\\ No newline at end of file\n+ \n\\ No newline at end of file\n"
                },
                {
                    "date": 1747804641574,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,408 @@\n- \n\\ No newline at end of file\n+\"use client\";\r\n+\r\n+import { useState, useEffect } from \"react\";\r\n+import Link from \"next/link\";\r\n+import { useVietnameseAddress } from \"@/hooks/useVietnameseAddress\";\r\n+import OrderConfirmationModal from \"@/components/OrderConfirmationModal\";\r\n+import { toast } from \"react-hot-toast\";\r\n+import { useRouter } from \"next/navigation\";\r\n+\r\n+export default function ShippingPage({\r\n+  userEmail: propUserEmail,\r\n+  isShippingComplete,\r\n+  showAdditionalContact,\r\n+  showPaymentDetails,\r\n+  errors,\r\n+  handleShippingComplete,\r\n+  handleAdditionalContactToggle,\r\n+  order,\r\n+}) {\r\n+  const router = useRouter();\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [showPaymentSection, setShowPaymentSection] = useState(false);\r\n+  const [showConfirmationModal, setShowConfirmationModal] = useState(false);\r\n+  const [orderDetails, setOrderDetails] = useState(null);\r\n+  const [localUserEmail, setLocalUserEmail] = useState(\"\");\r\n+  const [formData, setFormData] = useState({\r\n+    firstName: \"\",\r\n+    lastName: \"\",\r\n+    address: \"\",\r\n+    phone: \"\",\r\n+    additionalPhone: \"\",\r\n+    apartment: \"\",\r\n+  });\r\n+\r\n+  const {\r\n+    provinces,\r\n+    districts,\r\n+    wards,\r\n+    selectedProvince,\r\n+    selectedDistrict,\r\n+    selectedWard,\r\n+    selectedProvinceName,\r\n+    selectedDistrictName,\r\n+    selectedWardName,\r\n+    handleProvinceChange,\r\n+    handleDistrictChange,\r\n+    handleWardChange\r\n+  } = useVietnameseAddress();\r\n+\r\n+  useEffect(() => {\r\n+    const email = localStorage.getItem('userEmail') || sessionStorage.getItem('userEmail');\r\n+    if (email) {\r\n+      setLocalUserEmail(email);\r\n+    }\r\n+  }, []);\r\n+\r\n+  const userEmail = propUserEmail || localUserEmail;\r\n+\r\n+  const handleInputChange = (e) => {\r\n+    const { name, value } = e.target;\r\n+    setFormData(prev => ({\r\n+      ...prev,\r\n+      [name]: value\r\n+    }));\r\n+  };\r\n+\r\n+  const handleContinueToPayment = (e) => {\r\n+    e.preventDefault();\r\n+    const shippingForm = document.getElementById('shippingForm');\r\n+    if (shippingForm.checkValidity()) {\r\n+      setShowPaymentSection(true);\r\n+      const paymentSection = document.getElementById('paymentSection');\r\n+      if (paymentSection) {\r\n+        paymentSection.scrollIntoView({ behavior: 'smooth' });\r\n+      }\r\n+    } else {\r\n+      shippingForm.reportValidity();\r\n+    }\r\n+  };\r\n+\r\n+  const handleCompleteOrder = async (e) => {\r\n+    e.preventDefault();\r\n+    \r\n+    try {\r\n+      if (!selectedProvince || !selectedDistrict || !selectedWard) {\r\n+        toast.error(\"Vui lòng chọn đầy đủ thông tin địa chỉ\");\r\n+        return;\r\n+      }\r\n+\r\n+      if (!formData.firstName || !formData.lastName || !formData.phone) {\r\n+        toast.error(\"Vui lòng điền đầy đủ thông tin bắt buộc\");\r\n+        return;\r\n+      }\r\n+\r\n+      const now = new Date();\r\n+      const orderCode = `AISH${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;\r\n+\r\n+      const subtotal = order.items.reduce((total, item) => {\r\n+        const priceStr = typeof item.price === 'string' ? item.price.replace('AU$', '').trim() : item.price;\r\n+        const price = parseFloat(priceStr) || 0;\r\n+        return total + (price * item.quantity);\r\n+      }, 0);\r\n+\r\n+      const details = {\r\n+        orderNumber: orderCode,\r\n+        fullName: `${formData.firstName} ${formData.lastName}`,\r\n+        email: userEmail,\r\n+        phone: formData.phone,\r\n+        additionalPhone: formData.additionalPhone || null,\r\n+        apartment: formData.apartment || null,\r\n+        ward: selectedWardName || \"\",\r\n+        district: selectedDistrictName || \"\",\r\n+        province: selectedProvinceName || \"\",\r\n+        items: order.items.map(item => ({\r\n+          ...item,\r\n+          price: typeof item.price === 'string' ? parseFloat(item.price.replace('AU$', '').trim()) : item.price\r\n+        })),\r\n+        subtotal: subtotal,\r\n+        shippingFee: \"Free\",\r\n+        promoCode: order.promoCode || null,\r\n+        promoAmount: order.promoAmount || 0,\r\n+        total: subtotal - (order.promoAmount || 0),\r\n+        paymentMethod: paymentMethod,\r\n+        status: 'pending',\r\n+        paymentStatus: 'pending',\r\n+        shippingStatus: 'pending'\r\n+      };\r\n+\r\n+      setOrderDetails(details);\r\n+      setShowConfirmationModal(true);\r\n+    } catch (error) {\r\n+      console.error(\"Error preparing order:\", error);\r\n+      toast.error(\"Có lỗi xảy ra khi chuẩn bị đơn hàng. Vui lòng thử lại.\");\r\n+    }\r\n+  };\r\n+\r\n+  const handlePaymentMethodChange = (method) => {\r\n+    setPaymentMethod(method);\r\n+  };\r\n+\r\n+  const renderPaymentInfo = () => {\r\n+    if (!paymentMethod) return null;\r\n+\r\n+    if (paymentMethod === 'cod') {\r\n+      return (\r\n+        <div className=\"mt-5 p-4 bg-gray-50 rounded-md\">\r\n+          <p className=\"text-sm text-gray-600 italic\">\r\n+            Quý khách ghi nhớ mã đơn hàng và nhắn tin cho Facebook hoặc Instagram aish.aish.vn nếu muốn tra cứu mã vận đơn nhé\r\n+          </p>\r\n+        </div>\r\n+      );\r\n+    }\r\n+\r\n+    if (paymentMethod === 'bank') {\r\n+      return (\r\n+        <div className=\"mt-5 p-4 bg-gray-50 rounded-md\">\r\n+          <h3 className=\"text-sm font-semibold mb-3\">\r\n+            Thông tin chuyển khoản\r\n+          </h3>\r\n+          <div className=\"text-sm space-y-2\">\r\n+            <p>Ngân hàng: MB BANK</p>\r\n+            <p>Chủ tài khoản: PHAN THUY TRUC DAO</p>\r\n+            <p>Số tài khoản: 024052306</p>\r\n+            <p>Nội dung chuyển khoản: MÃ ĐƠN HÀNG + SĐT</p>\r\n+            <p className=\"mt-4 text-gray-600 italic\">\r\n+              Sau khi đặt hàng thành công, quý khách sẽ thấy mã đơn hàng tại trang. Quý khách vui lòng chuyển khoản đúng nội dung và chụp màn hình gửi về Facebook hoặc Instagram aish.aish.vn nhaa\r\n+            </p>\r\n+          </div>\r\n+        </div>\r\n+      );\r\n+    }\r\n+  };\r\n+\r\n+  return (\r\n+    <div className=\"flex-1 bg-white p-6 border border-gray-200\">\r\n+      <div className=\"mb-8\">\r\n+        <h2 className=\"text-lg font-semibold mb-3\">THÔNG TIN LIÊN HỆ</h2>\r\n+        <p className=\"text-sm\">\r\n+          {userEmail ? (\r\n+            <>\r\n+              {userEmail} (<Link href=\"/logout\" className=\"underline hover:text-gray-600\">Đăng xuất</Link>)\r\n+            </>\r\n+          ) : (\r\n+            \"Bạn chưa đăng nhập\"\r\n+          )}\r\n+        </p>\r\n+      </div>\r\n+\r\n+      <div className=\"mb-8\">\r\n+        <h2 className=\"text-lg font-semibold mb-3\">ĐỊA CHỈ GIAO HÀNG</h2>\r\n+        <form id=\"shippingForm\" className=\"space-y-4\">\r\n+          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n+            <div>\r\n+              <label className=\"block text-sm mb-1\">Tên *</label>\r\n+              <input\r\n+                name=\"firstName\"\r\n+                type=\"text\"\r\n+                value={formData.firstName}\r\n+                onChange={handleInputChange}\r\n+                className={`w-full px-3 py-2 border rounded-md ${errors.firstName ? 'border-red-500' : 'border-gray-300'}`}\r\n+                required\r\n+              />\r\n+            </div>\r\n+            <div>\r\n+              <label className=\"block text-sm mb-1\">Họ *</label>\r\n+              <input\r\n+                name=\"lastName\"\r\n+                type=\"text\"\r\n+                value={formData.lastName}\r\n+                onChange={handleInputChange}\r\n+                className={`w-full px-3 py-2 border rounded-md ${errors.lastName ? 'border-red-500' : 'border-gray-300'}`}\r\n+                required\r\n+              />\r\n+            </div>\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Số điện thoại *</label>\r\n+            <input\r\n+              name=\"phone\"\r\n+              type=\"tel\"\r\n+              value={formData.phone}\r\n+              onChange={handleInputChange}\r\n+              className={`w-full px-3 py-2 border rounded-md ${errors.phone ? 'border-red-500' : 'border-gray-300'}`}\r\n+              required\r\n+            />\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Số điện thoại phụ (không bắt buộc)</label>\r\n+            <input\r\n+              name=\"additionalPhone\"\r\n+              type=\"tel\"\r\n+              value={formData.additionalPhone}\r\n+              onChange={handleInputChange}\r\n+              className=\"w-full px-3 py-2 border border-gray-300 rounded-md\"\r\n+            />\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Tỉnh/Thành phố *</label>\r\n+            <select\r\n+              value={selectedProvince}\r\n+              onChange={handleProvinceChange}\r\n+              className={`w-full px-3 py-2 border rounded-md ${errors.province ? 'border-red-500' : 'border-gray-300'}`}\r\n+              required\r\n+            >\r\n+              <option value=\"\">Chọn tỉnh/thành phố</option>\r\n+              {provinces.map((province) => (\r\n+                <option key={province.code} value={province.code}>\r\n+                  {province.name}\r\n+                </option>\r\n+              ))}\r\n+            </select>\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Quận/Huyện *</label>\r\n+            <select\r\n+              value={selectedDistrict}\r\n+              onChange={handleDistrictChange}\r\n+              className={`w-full px-3 py-2 border rounded-md ${errors.district ? 'border-red-500' : 'border-gray-300'}`}\r\n+              required\r\n+              disabled={!selectedProvince}\r\n+            >\r\n+              <option value=\"\">Chọn quận/huyện</option>\r\n+              {districts.map((district) => (\r\n+                <option key={district.code} value={district.code}>\r\n+                  {district.name}\r\n+                </option>\r\n+              ))}\r\n+            </select>\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Phường/Xã *</label>\r\n+            <select\r\n+              value={selectedWard}\r\n+              onChange={handleWardChange}\r\n+              className={`w-full px-3 py-2 border rounded-md ${errors.ward ? 'border-red-500' : 'border-gray-300'}`}\r\n+              required\r\n+              disabled={!selectedDistrict}\r\n+            >\r\n+              <option value=\"\">Chọn phường/xã</option>\r\n+              {wards.map((ward) => (\r\n+                <option key={ward.code} value={ward.code}>\r\n+                  {ward.name}\r\n+                </option>\r\n+              ))}\r\n+            </select>\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Địa chỉ *</label>\r\n+            <input\r\n+              name=\"address\"\r\n+              type=\"text\"\r\n+              value={formData.address}\r\n+              onChange={handleInputChange}\r\n+              className={`w-full px-3 py-2 border rounded-md ${errors.address ? 'border-red-500' : 'border-gray-300'}`}\r\n+              required\r\n+            />\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Số nhà, tên đường (không bắt buộc)</label>\r\n+            <input\r\n+              name=\"apartment\"\r\n+              type=\"text\"\r\n+              value={formData.apartment}\r\n+              onChange={handleInputChange}\r\n+              className=\"w-full px-3 py-2 border border-gray-300 rounded-md\"\r\n+            />\r\n+          </div>\r\n+\r\n+          <div className=\"flex justify-end\">\r\n+            <button\r\n+              type=\"button\"\r\n+              onClick={handleContinueToPayment}\r\n+              className=\"bg-black text-white px-6 py-2 rounded-md hover:bg-gray-800 transition-colors\"\r\n+            >\r\n+              Tiếp tục\r\n+            </button>\r\n+          </div>\r\n+        </form>\r\n+      </div>\r\n+\r\n+      {showPaymentSection && (\r\n+        <div id=\"paymentSection\" className=\"mb-8\">\r\n+          <h2 className=\"text-lg font-semibold mb-3\">PHƯƠNG THỨC THANH TOÁN</h2>\r\n+          <div className=\"space-y-4\">\r\n+            <div className=\"flex items-center\">\r\n+              <input\r\n+                type=\"radio\"\r\n+                id=\"cod\"\r\n+                name=\"paymentMethod\"\r\n+                value=\"cod\"\r\n+                checked={paymentMethod === \"cod\"}\r\n+                onChange={() => handlePaymentMethodChange(\"cod\")}\r\n+                className=\"mr-2\"\r\n+              />\r\n+              <label htmlFor=\"cod\" className=\"text-sm\">\r\n+                Thanh toán khi nhận hàng (COD)\r\n+              </label>\r\n+            </div>\r\n+            <div className=\"flex items-center\">\r\n+              <input\r\n+                type=\"radio\"\r\n+                id=\"bank\"\r\n+                name=\"paymentMethod\"\r\n+                value=\"bank\"\r\n+                checked={paymentMethod === \"bank\"}\r\n+                onChange={() => handlePaymentMethodChange(\"bank\")}\r\n+                className=\"mr-2\"\r\n+              />\r\n+              <label htmlFor=\"bank\" className=\"text-sm\">\r\n+                Chuyển khoản ngân hàng\r\n+              </label>\r\n+            </div>\r\n+            {renderPaymentInfo()}\r\n+          </div>\r\n+\r\n+          <div className=\"mt-6\">\r\n+            <button\r\n+              onClick={handleCompleteOrder}\r\n+              className=\"w-full bg-black text-white px-6 py-3 rounded-md hover:bg-gray-800 transition-colors\"\r\n+            >\r\n+              Hoàn tất đơn hàng\r\n+            </button>\r\n+          </div>\r\n+        </div>\r\n+      )}\r\n+\r\n+      {showConfirmationModal && orderDetails && (\r\n+        <OrderConfirmationModal\r\n+          orderDetails={orderDetails}\r\n+          onClose={() => setShowConfirmationModal(false)}\r\n+          onConfirm={async () => {\r\n+            try {\r\n+              const response = await fetch('/api/orders', {\r\n+                method: 'POST',\r\n+                headers: {\r\n+                  'Content-Type': 'application/json',\r\n+                },\r\n+                body: JSON.stringify(orderDetails),\r\n+              });\r\n+\r\n+              if (!response.ok) {\r\n+                throw new Error('Failed to create order');\r\n+              }\r\n+\r\n+              const data = await response.json();\r\n+              if (data.ok) {\r\n+                toast.success('Đặt hàng thành công!');\r\n+                router.push(`/order-success/${orderDetails.orderNumber}`);\r\n+              } else {\r\n+                throw new Error(data.message || 'Failed to create order');\r\n+              }\r\n+            } catch (error) {\r\n+              console.error('Error creating order:', error);\r\n+              toast.error('Có lỗi xảy ra khi tạo đơn hàng. Vui lòng thử lại.');\r\n+            }\r\n+          }}\r\n+        />\r\n+      )}\r\n+    </div>\r\n+  );\r\n+} \n\\ No newline at end of file\n"
                },
                {
                    "date": 1747804652650,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,408 +1,1 @@\n-\"use client\";\r\n-\r\n-import { useState, useEffect } from \"react\";\r\n-import Link from \"next/link\";\r\n-import { useVietnameseAddress } from \"@/hooks/useVietnameseAddress\";\r\n-import OrderConfirmationModal from \"@/components/OrderConfirmationModal\";\r\n-import { toast } from \"react-hot-toast\";\r\n-import { useRouter } from \"next/navigation\";\r\n-\r\n-export default function ShippingPage({\r\n-  userEmail: propUserEmail,\r\n-  isShippingComplete,\r\n-  showAdditionalContact,\r\n-  showPaymentDetails,\r\n-  errors,\r\n-  handleShippingComplete,\r\n-  handleAdditionalContactToggle,\r\n-  order,\r\n-}) {\r\n-  const router = useRouter();\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [showPaymentSection, setShowPaymentSection] = useState(false);\r\n-  const [showConfirmationModal, setShowConfirmationModal] = useState(false);\r\n-  const [orderDetails, setOrderDetails] = useState(null);\r\n-  const [localUserEmail, setLocalUserEmail] = useState(\"\");\r\n-  const [formData, setFormData] = useState({\r\n-    firstName: \"\",\r\n-    lastName: \"\",\r\n-    address: \"\",\r\n-    phone: \"\",\r\n-    additionalPhone: \"\",\r\n-    apartment: \"\",\r\n-  });\r\n-\r\n-  const {\r\n-    provinces,\r\n-    districts,\r\n-    wards,\r\n-    selectedProvince,\r\n-    selectedDistrict,\r\n-    selectedWard,\r\n-    selectedProvinceName,\r\n-    selectedDistrictName,\r\n-    selectedWardName,\r\n-    handleProvinceChange,\r\n-    handleDistrictChange,\r\n-    handleWardChange\r\n-  } = useVietnameseAddress();\r\n-\r\n-  useEffect(() => {\r\n-    const email = localStorage.getItem('userEmail') || sessionStorage.getItem('userEmail');\r\n-    if (email) {\r\n-      setLocalUserEmail(email);\r\n-    }\r\n-  }, []);\r\n-\r\n-  const userEmail = propUserEmail || localUserEmail;\r\n-\r\n-  const handleInputChange = (e) => {\r\n-    const { name, value } = e.target;\r\n-    setFormData(prev => ({\r\n-      ...prev,\r\n-      [name]: value\r\n-    }));\r\n-  };\r\n-\r\n-  const handleContinueToPayment = (e) => {\r\n-    e.preventDefault();\r\n-    const shippingForm = document.getElementById('shippingForm');\r\n-    if (shippingForm.checkValidity()) {\r\n-      setShowPaymentSection(true);\r\n-      const paymentSection = document.getElementById('paymentSection');\r\n-      if (paymentSection) {\r\n-        paymentSection.scrollIntoView({ behavior: 'smooth' });\r\n-      }\r\n-    } else {\r\n-      shippingForm.reportValidity();\r\n-    }\r\n-  };\r\n-\r\n-  const handleCompleteOrder = async (e) => {\r\n-    e.preventDefault();\r\n-    \r\n-    try {\r\n-      if (!selectedProvince || !selectedDistrict || !selectedWard) {\r\n-        toast.error(\"Vui lòng chọn đầy đủ thông tin địa chỉ\");\r\n-        return;\r\n-      }\r\n-\r\n-      if (!formData.firstName || !formData.lastName || !formData.phone) {\r\n-        toast.error(\"Vui lòng điền đầy đủ thông tin bắt buộc\");\r\n-        return;\r\n-      }\r\n-\r\n-      const now = new Date();\r\n-      const orderCode = `AISH${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;\r\n-\r\n-      const subtotal = order.items.reduce((total, item) => {\r\n-        const priceStr = typeof item.price === 'string' ? item.price.replace('AU$', '').trim() : item.price;\r\n-        const price = parseFloat(priceStr) || 0;\r\n-        return total + (price * item.quantity);\r\n-      }, 0);\r\n-\r\n-      const details = {\r\n-        orderNumber: orderCode,\r\n-        fullName: `${formData.firstName} ${formData.lastName}`,\r\n-        email: userEmail,\r\n-        phone: formData.phone,\r\n-        additionalPhone: formData.additionalPhone || null,\r\n-        apartment: formData.apartment || null,\r\n-        ward: selectedWardName || \"\",\r\n-        district: selectedDistrictName || \"\",\r\n-        province: selectedProvinceName || \"\",\r\n-        items: order.items.map(item => ({\r\n-          ...item,\r\n-          price: typeof item.price === 'string' ? parseFloat(item.price.replace('AU$', '').trim()) : item.price\r\n-        })),\r\n-        subtotal: subtotal,\r\n-        shippingFee: \"Free\",\r\n-        promoCode: order.promoCode || null,\r\n-        promoAmount: order.promoAmount || 0,\r\n-        total: subtotal - (order.promoAmount || 0),\r\n-        paymentMethod: paymentMethod,\r\n-        status: 'pending',\r\n-        paymentStatus: 'pending',\r\n-        shippingStatus: 'pending'\r\n-      };\r\n-\r\n-      setOrderDetails(details);\r\n-      setShowConfirmationModal(true);\r\n-    } catch (error) {\r\n-      console.error(\"Error preparing order:\", error);\r\n-      toast.error(\"Có lỗi xảy ra khi chuẩn bị đơn hàng. Vui lòng thử lại.\");\r\n-    }\r\n-  };\r\n-\r\n-  const handlePaymentMethodChange = (method) => {\r\n-    setPaymentMethod(method);\r\n-  };\r\n-\r\n-  const renderPaymentInfo = () => {\r\n-    if (!paymentMethod) return null;\r\n-\r\n-    if (paymentMethod === 'cod') {\r\n-      return (\r\n-        <div className=\"mt-5 p-4 bg-gray-50 rounded-md\">\r\n-          <p className=\"text-sm text-gray-600 italic\">\r\n-            Quý khách ghi nhớ mã đơn hàng và nhắn tin cho Facebook hoặc Instagram aish.aish.vn nếu muốn tra cứu mã vận đơn nhé\r\n-          </p>\r\n-        </div>\r\n-      );\r\n-    }\r\n-\r\n-    if (paymentMethod === 'bank') {\r\n-      return (\r\n-        <div className=\"mt-5 p-4 bg-gray-50 rounded-md\">\r\n-          <h3 className=\"text-sm font-semibold mb-3\">\r\n-            Thông tin chuyển khoản\r\n-          </h3>\r\n-          <div className=\"text-sm space-y-2\">\r\n-            <p>Ngân hàng: MB BANK</p>\r\n-            <p>Chủ tài khoản: PHAN THUY TRUC DAO</p>\r\n-            <p>Số tài khoản: 024052306</p>\r\n-            <p>Nội dung chuyển khoản: MÃ ĐƠN HÀNG + SĐT</p>\r\n-            <p className=\"mt-4 text-gray-600 italic\">\r\n-              Sau khi đặt hàng thành công, quý khách sẽ thấy mã đơn hàng tại trang. Quý khách vui lòng chuyển khoản đúng nội dung và chụp màn hình gửi về Facebook hoặc Instagram aish.aish.vn nhaa\r\n-            </p>\r\n-          </div>\r\n-        </div>\r\n-      );\r\n-    }\r\n-  };\r\n-\r\n-  return (\r\n-    <div className=\"flex-1 bg-white p-6 border border-gray-200\">\r\n-      <div className=\"mb-8\">\r\n-        <h2 className=\"text-lg font-semibold mb-3\">THÔNG TIN LIÊN HỆ</h2>\r\n-        <p className=\"text-sm\">\r\n-          {userEmail ? (\r\n-            <>\r\n-              {userEmail} (<Link href=\"/logout\" className=\"underline hover:text-gray-600\">Đăng xuất</Link>)\r\n-            </>\r\n-          ) : (\r\n-            \"Bạn chưa đăng nhập\"\r\n-          )}\r\n-        </p>\r\n-      </div>\r\n-\r\n-      <div className=\"mb-8\">\r\n-        <h2 className=\"text-lg font-semibold mb-3\">ĐỊA CHỈ GIAO HÀNG</h2>\r\n-        <form id=\"shippingForm\" className=\"space-y-4\">\r\n-          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n-            <div>\r\n-              <label className=\"block text-sm mb-1\">Tên *</label>\r\n-              <input\r\n-                name=\"firstName\"\r\n-                type=\"text\"\r\n-                value={formData.firstName}\r\n-                onChange={handleInputChange}\r\n-                className={`w-full px-3 py-2 border rounded-md ${errors.firstName ? 'border-red-500' : 'border-gray-300'}`}\r\n-                required\r\n-              />\r\n-            </div>\r\n-            <div>\r\n-              <label className=\"block text-sm mb-1\">Họ *</label>\r\n-              <input\r\n-                name=\"lastName\"\r\n-                type=\"text\"\r\n-                value={formData.lastName}\r\n-                onChange={handleInputChange}\r\n-                className={`w-full px-3 py-2 border rounded-md ${errors.lastName ? 'border-red-500' : 'border-gray-300'}`}\r\n-                required\r\n-              />\r\n-            </div>\r\n-          </div>\r\n-\r\n-          <div>\r\n-            <label className=\"block text-sm mb-1\">Số điện thoại *</label>\r\n-            <input\r\n-              name=\"phone\"\r\n-              type=\"tel\"\r\n-              value={formData.phone}\r\n-              onChange={handleInputChange}\r\n-              className={`w-full px-3 py-2 border rounded-md ${errors.phone ? 'border-red-500' : 'border-gray-300'}`}\r\n-              required\r\n-            />\r\n-          </div>\r\n-\r\n-          <div>\r\n-            <label className=\"block text-sm mb-1\">Số điện thoại phụ (không bắt buộc)</label>\r\n-            <input\r\n-              name=\"additionalPhone\"\r\n-              type=\"tel\"\r\n-              value={formData.additionalPhone}\r\n-              onChange={handleInputChange}\r\n-              className=\"w-full px-3 py-2 border border-gray-300 rounded-md\"\r\n-            />\r\n-          </div>\r\n-\r\n-          <div>\r\n-            <label className=\"block text-sm mb-1\">Tỉnh/Thành phố *</label>\r\n-            <select\r\n-              value={selectedProvince}\r\n-              onChange={handleProvinceChange}\r\n-              className={`w-full px-3 py-2 border rounded-md ${errors.province ? 'border-red-500' : 'border-gray-300'}`}\r\n-              required\r\n-            >\r\n-              <option value=\"\">Chọn tỉnh/thành phố</option>\r\n-              {provinces.map((province) => (\r\n-                <option key={province.code} value={province.code}>\r\n-                  {province.name}\r\n-                </option>\r\n-              ))}\r\n-            </select>\r\n-          </div>\r\n-\r\n-          <div>\r\n-            <label className=\"block text-sm mb-1\">Quận/Huyện *</label>\r\n-            <select\r\n-              value={selectedDistrict}\r\n-              onChange={handleDistrictChange}\r\n-              className={`w-full px-3 py-2 border rounded-md ${errors.district ? 'border-red-500' : 'border-gray-300'}`}\r\n-              required\r\n-              disabled={!selectedProvince}\r\n-            >\r\n-              <option value=\"\">Chọn quận/huyện</option>\r\n-              {districts.map((district) => (\r\n-                <option key={district.code} value={district.code}>\r\n-                  {district.name}\r\n-                </option>\r\n-              ))}\r\n-            </select>\r\n-          </div>\r\n-\r\n-          <div>\r\n-            <label className=\"block text-sm mb-1\">Phường/Xã *</label>\r\n-            <select\r\n-              value={selectedWard}\r\n-              onChange={handleWardChange}\r\n-              className={`w-full px-3 py-2 border rounded-md ${errors.ward ? 'border-red-500' : 'border-gray-300'}`}\r\n-              required\r\n-              disabled={!selectedDistrict}\r\n-            >\r\n-              <option value=\"\">Chọn phường/xã</option>\r\n-              {wards.map((ward) => (\r\n-                <option key={ward.code} value={ward.code}>\r\n-                  {ward.name}\r\n-                </option>\r\n-              ))}\r\n-            </select>\r\n-          </div>\r\n-\r\n-          <div>\r\n-            <label className=\"block text-sm mb-1\">Địa chỉ *</label>\r\n-            <input\r\n-              name=\"address\"\r\n-              type=\"text\"\r\n-              value={formData.address}\r\n-              onChange={handleInputChange}\r\n-              className={`w-full px-3 py-2 border rounded-md ${errors.address ? 'border-red-500' : 'border-gray-300'}`}\r\n-              required\r\n-            />\r\n-          </div>\r\n-\r\n-          <div>\r\n-            <label className=\"block text-sm mb-1\">Số nhà, tên đường (không bắt buộc)</label>\r\n-            <input\r\n-              name=\"apartment\"\r\n-              type=\"text\"\r\n-              value={formData.apartment}\r\n-              onChange={handleInputChange}\r\n-              className=\"w-full px-3 py-2 border border-gray-300 rounded-md\"\r\n-            />\r\n-          </div>\r\n-\r\n-          <div className=\"flex justify-end\">\r\n-            <button\r\n-              type=\"button\"\r\n-              onClick={handleContinueToPayment}\r\n-              className=\"bg-black text-white px-6 py-2 rounded-md hover:bg-gray-800 transition-colors\"\r\n-            >\r\n-              Tiếp tục\r\n-            </button>\r\n-          </div>\r\n-        </form>\r\n-      </div>\r\n-\r\n-      {showPaymentSection && (\r\n-        <div id=\"paymentSection\" className=\"mb-8\">\r\n-          <h2 className=\"text-lg font-semibold mb-3\">PHƯƠNG THỨC THANH TOÁN</h2>\r\n-          <div className=\"space-y-4\">\r\n-            <div className=\"flex items-center\">\r\n-              <input\r\n-                type=\"radio\"\r\n-                id=\"cod\"\r\n-                name=\"paymentMethod\"\r\n-                value=\"cod\"\r\n-                checked={paymentMethod === \"cod\"}\r\n-                onChange={() => handlePaymentMethodChange(\"cod\")}\r\n-                className=\"mr-2\"\r\n-              />\r\n-              <label htmlFor=\"cod\" className=\"text-sm\">\r\n-                Thanh toán khi nhận hàng (COD)\r\n-              </label>\r\n-            </div>\r\n-            <div className=\"flex items-center\">\r\n-              <input\r\n-                type=\"radio\"\r\n-                id=\"bank\"\r\n-                name=\"paymentMethod\"\r\n-                value=\"bank\"\r\n-                checked={paymentMethod === \"bank\"}\r\n-                onChange={() => handlePaymentMethodChange(\"bank\")}\r\n-                className=\"mr-2\"\r\n-              />\r\n-              <label htmlFor=\"bank\" className=\"text-sm\">\r\n-                Chuyển khoản ngân hàng\r\n-              </label>\r\n-            </div>\r\n-            {renderPaymentInfo()}\r\n-          </div>\r\n-\r\n-          <div className=\"mt-6\">\r\n-            <button\r\n-              onClick={handleCompleteOrder}\r\n-              className=\"w-full bg-black text-white px-6 py-3 rounded-md hover:bg-gray-800 transition-colors\"\r\n-            >\r\n-              Hoàn tất đơn hàng\r\n-            </button>\r\n-          </div>\r\n-        </div>\r\n-      )}\r\n-\r\n-      {showConfirmationModal && orderDetails && (\r\n-        <OrderConfirmationModal\r\n-          orderDetails={orderDetails}\r\n-          onClose={() => setShowConfirmationModal(false)}\r\n-          onConfirm={async () => {\r\n-            try {\r\n-              const response = await fetch('/api/orders', {\r\n-                method: 'POST',\r\n-                headers: {\r\n-                  'Content-Type': 'application/json',\r\n-                },\r\n-                body: JSON.stringify(orderDetails),\r\n-              });\r\n-\r\n-              if (!response.ok) {\r\n-                throw new Error('Failed to create order');\r\n-              }\r\n-\r\n-              const data = await response.json();\r\n-              if (data.ok) {\r\n-                toast.success('Đặt hàng thành công!');\r\n-                router.push(`/order-success/${orderDetails.orderNumber}`);\r\n-              } else {\r\n-                throw new Error(data.message || 'Failed to create order');\r\n-              }\r\n-            } catch (error) {\r\n-              console.error('Error creating order:', error);\r\n-              toast.error('Có lỗi xảy ra khi tạo đơn hàng. Vui lòng thử lại.');\r\n-            }\r\n-          }}\r\n-        />\r\n-      )}\r\n-    </div>\r\n-  );\r\n-} \n\\ No newline at end of file\n+ \n\\ No newline at end of file\n"
                },
                {
                    "date": 1747804701846,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,88 @@\n- \n\\ No newline at end of file\n+const handleCompleteOrder = async (e) => {\r\n+  e.preventDefault();\r\n+  \r\n+  try {\r\n+    if (!selectedProvince || !selectedDistrict || !selectedWard) {\r\n+      toast.error(\"Vui lòng chọn đầy đủ thông tin địa chỉ\");\r\n+      return;\r\n+    }\r\n+\r\n+    if (!formData.firstName || !formData.lastName || !formData.phone) {\r\n+      toast.error(\"Vui lòng điền đầy đủ thông tin bắt buộc\");\r\n+      return;\r\n+    }\r\n+\r\n+    const now = new Date();\r\n+    const orderNumber = `AISH${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;\r\n+\r\n+    const subtotal = order.items.reduce((total, item) => {\r\n+      const priceStr = typeof item.price === 'string' ? item.price.replace('AU$', '').trim() : item.price;\r\n+      const price = parseFloat(priceStr) || 0;\r\n+      return total + (price * item.quantity);\r\n+    }, 0);\r\n+\r\n+    const details = {\r\n+      orderNumber: orderNumber,\r\n+      fullName: `${formData.firstName} ${formData.lastName}`,\r\n+      email: userEmail,\r\n+      phone: formData.phone,\r\n+      additionalPhone: formData.additionalPhone || null,\r\n+      apartment: formData.apartment || null,\r\n+      ward: selectedWardName || \"\",\r\n+      district: selectedDistrictName || \"\",\r\n+      province: selectedProvinceName || \"\",\r\n+      items: order.items.map(item => ({\r\n+        ...item,\r\n+        price: typeof item.price === 'string' ? parseFloat(item.price.replace('AU$', '').trim()) : item.price\r\n+      })),\r\n+      subtotal: subtotal,\r\n+      shippingFee: \"Free\",\r\n+      promoCode: order.promoCode || null,\r\n+      promoAmount: order.promoAmount || 0,\r\n+      total: subtotal - (order.promoAmount || 0),\r\n+      paymentMethod: paymentMethod,\r\n+      status: 'pending',\r\n+      paymentStatus: 'pending',\r\n+      shippingStatus: 'pending'\r\n+    };\r\n+\r\n+    setOrderDetails(details);\r\n+    setShowConfirmationModal(true);\r\n+  } catch (error) {\r\n+    console.error(\"Error preparing order:\", error);\r\n+    toast.error(\"Có lỗi xảy ra khi chuẩn bị đơn hàng. Vui lòng thử lại.\");\r\n+  }\r\n+};\r\n+\r\n+{showConfirmationModal && orderDetails && (\r\n+  <OrderConfirmationModal\r\n+    orderDetails={orderDetails}\r\n+    onClose={() => setShowConfirmationModal(false)}\r\n+    onConfirm={async () => {\r\n+      try {\r\n+        const response = await fetch('/api/orders', {\r\n+          method: 'POST',\r\n+          headers: {\r\n+            'Content-Type': 'application/json',\r\n+          },\r\n+          body: JSON.stringify(orderDetails),\r\n+        });\r\n+\r\n+        if (!response.ok) {\r\n+          throw new Error('Failed to create order');\r\n+        }\r\n+\r\n+        const data = await response.json();\r\n+        if (data.ok) {\r\n+          toast.success('Đặt hàng thành công!');\r\n+          router.push(`/order-success/${orderDetails.orderNumber}`);\r\n+        } else {\r\n+          throw new Error(data.message || 'Failed to create order');\r\n+        }\r\n+      } catch (error) {\r\n+        console.error('Error creating order:', error);\r\n+        toast.error('Có lỗi xảy ra khi tạo đơn hàng. Vui lòng thử lại.');\r\n+      }\r\n+    }}\r\n+  />\r\n+)} \n\\ No newline at end of file\n"
                },
                {
                    "date": 1747804774409,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,414 @@\n- \n\\ No newline at end of file\n+\"use client\";\r\n+\r\n+import { useState, useEffect } from \"react\";\r\n+import Link from \"next/link\";\r\n+import { useVietnameseAddress } from \"@/hooks/useVietnameseAddress\";\r\n+import OrderConfirmationModal from \"@/components/OrderConfirmationModal\";\r\n+import { toast } from \"react-hot-toast\";\r\n+import { useRouter } from \"next/navigation\";\r\n+\r\n+interface ShippingPageProps {\r\n+  userEmail: string;\r\n+  order: {\r\n+    items: Array<{\r\n+      id: string;\r\n+      name: string;\r\n+      price: number | string;\r\n+      quantity: number;\r\n+    }>;\r\n+    promoCode?: string | null;\r\n+    promoAmount?: number;\r\n+  };\r\n+  errors: Record<string, string>;\r\n+}\r\n+\r\n+export default function ShippingPage({ userEmail: propUserEmail, order, errors }: ShippingPageProps) {\r\n+  const router = useRouter();\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [showPaymentSection, setShowPaymentSection] = useState(false);\r\n+  const [showConfirmationModal, setShowConfirmationModal] = useState(false);\r\n+  const [orderDetails, setOrderDetails] = useState<any>(null);\r\n+  const [localUserEmail, setLocalUserEmail] = useState(\"\");\r\n+  const [formData, setFormData] = useState({\r\n+    firstName: \"\",\r\n+    lastName: \"\",\r\n+    address: \"\",\r\n+    phone: \"\",\r\n+    additionalPhone: \"\",\r\n+    apartment: \"\",\r\n+  });\r\n+\r\n+  const {\r\n+    provinces,\r\n+    districts,\r\n+    wards,\r\n+    selectedProvince,\r\n+    selectedDistrict,\r\n+    selectedWard,\r\n+    selectedProvinceName,\r\n+    selectedDistrictName,\r\n+    selectedWardName,\r\n+    handleProvinceChange,\r\n+    handleDistrictChange,\r\n+    handleWardChange\r\n+  } = useVietnameseAddress();\r\n+\r\n+  useEffect(() => {\r\n+    const email = localStorage.getItem('userEmail') || sessionStorage.getItem('userEmail');\r\n+    if (email) {\r\n+      setLocalUserEmail(email);\r\n+    }\r\n+  }, []);\r\n+\r\n+  const userEmail = propUserEmail || localUserEmail;\r\n+\r\n+  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n+    const { name, value } = e.target;\r\n+    setFormData(prev => ({\r\n+      ...prev,\r\n+      [name]: value\r\n+    }));\r\n+  };\r\n+\r\n+  const handleContinueToPayment = (e: React.FormEvent) => {\r\n+    e.preventDefault();\r\n+    const shippingForm = document.getElementById('shippingForm');\r\n+    if (shippingForm?.checkValidity()) {\r\n+      setShowPaymentSection(true);\r\n+      const paymentSection = document.getElementById('paymentSection');\r\n+      if (paymentSection) {\r\n+        paymentSection.scrollIntoView({ behavior: 'smooth' });\r\n+      }\r\n+    } else {\r\n+      shippingForm?.reportValidity();\r\n+    }\r\n+  };\r\n+\r\n+  const handleCompleteOrder = async (e: React.FormEvent) => {\r\n+    e.preventDefault();\r\n+    \r\n+    try {\r\n+      if (!selectedProvince || !selectedDistrict || !selectedWard) {\r\n+        toast.error(\"Vui lòng chọn đầy đủ thông tin địa chỉ\");\r\n+        return;\r\n+      }\r\n+\r\n+      if (!formData.firstName || !formData.lastName || !formData.phone) {\r\n+        toast.error(\"Vui lòng điền đầy đủ thông tin bắt buộc\");\r\n+        return;\r\n+      }\r\n+\r\n+      const now = new Date();\r\n+      const orderNumber = `AISH${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;\r\n+\r\n+      const subtotal = order.items.reduce((total: number, item) => {\r\n+        const priceStr = typeof item.price === 'string' ? item.price.replace('AU$', '').trim() : item.price;\r\n+        const price = parseFloat(String(priceStr)) || 0;\r\n+        return total + (price * item.quantity);\r\n+      }, 0);\r\n+\r\n+      const details = {\r\n+        orderNumber: orderNumber,\r\n+        fullName: `${formData.firstName} ${formData.lastName}`,\r\n+        email: userEmail,\r\n+        phone: formData.phone,\r\n+        additionalPhone: formData.additionalPhone || null,\r\n+        apartment: formData.apartment || null,\r\n+        ward: selectedWardName || \"\",\r\n+        district: selectedDistrictName || \"\",\r\n+        province: selectedProvinceName || \"\",\r\n+        items: order.items.map(item => ({\r\n+          ...item,\r\n+          price: typeof item.price === 'string' ? parseFloat(item.price.replace('AU$', '').trim()) : item.price\r\n+        })),\r\n+        subtotal: subtotal,\r\n+        shippingFee: \"Free\",\r\n+        promoCode: order.promoCode || null,\r\n+        promoAmount: order.promoAmount || 0,\r\n+        total: subtotal - (order.promoAmount || 0),\r\n+        paymentMethod: paymentMethod,\r\n+        status: 'pending',\r\n+        paymentStatus: 'pending',\r\n+        shippingStatus: 'pending'\r\n+      };\r\n+\r\n+      setOrderDetails(details);\r\n+      setShowConfirmationModal(true);\r\n+    } catch (error) {\r\n+      console.error(\"Error preparing order:\", error);\r\n+      toast.error(\"Có lỗi xảy ra khi chuẩn bị đơn hàng. Vui lòng thử lại.\");\r\n+    }\r\n+  };\r\n+\r\n+  const handlePaymentMethodChange = (method: string) => {\r\n+    setPaymentMethod(method);\r\n+  };\r\n+\r\n+  const renderPaymentInfo = () => {\r\n+    if (!paymentMethod) return null;\r\n+\r\n+    if (paymentMethod === 'cod') {\r\n+      return (\r\n+        <div className=\"mt-5 p-4 bg-gray-50 rounded-md\">\r\n+          <p className=\"text-sm text-gray-600 italic\">\r\n+            Quý khách ghi nhớ mã đơn hàng và nhắn tin cho Facebook hoặc Instagram aish.aish.vn nếu muốn tra cứu mã vận đơn nhé\r\n+          </p>\r\n+        </div>\r\n+      );\r\n+    }\r\n+\r\n+    if (paymentMethod === 'bank') {\r\n+      return (\r\n+        <div className=\"mt-5 p-4 bg-gray-50 rounded-md\">\r\n+          <h3 className=\"text-sm font-semibold mb-3\">\r\n+            Thông tin chuyển khoản\r\n+          </h3>\r\n+          <div className=\"text-sm space-y-2\">\r\n+            <p>Ngân hàng: MB BANK</p>\r\n+            <p>Chủ tài khoản: PHAN THUY TRUC DAO</p>\r\n+            <p>Số tài khoản: 024052306</p>\r\n+            <p>Nội dung chuyển khoản: MÃ ĐƠN HÀNG + SĐT</p>\r\n+            <p className=\"mt-4 text-gray-600 italic\">\r\n+              Sau khi đặt hàng thành công, quý khách sẽ thấy mã đơn hàng tại trang. Quý khách vui lòng chuyển khoản đúng nội dung và chụp màn hình gửi về Facebook hoặc Instagram aish.aish.vn nhaa\r\n+            </p>\r\n+          </div>\r\n+        </div>\r\n+      );\r\n+    }\r\n+  };\r\n+\r\n+  return (\r\n+    <div className=\"flex-1 bg-white p-6 border border-gray-200\">\r\n+      <div className=\"mb-8\">\r\n+        <h2 className=\"text-lg font-semibold mb-3\">THÔNG TIN LIÊN HỆ</h2>\r\n+        <p className=\"text-sm\">\r\n+          {userEmail ? (\r\n+            <>\r\n+              {userEmail} (<Link href=\"/logout\" className=\"underline hover:text-gray-600\">Đăng xuất</Link>)\r\n+            </>\r\n+          ) : (\r\n+            \"Bạn chưa đăng nhập\"\r\n+          )}\r\n+        </p>\r\n+      </div>\r\n+\r\n+      <div className=\"mb-8\">\r\n+        <h2 className=\"text-lg font-semibold mb-3\">ĐỊA CHỈ GIAO HÀNG</h2>\r\n+        <form id=\"shippingForm\" className=\"space-y-4\">\r\n+          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n+            <div>\r\n+              <label className=\"block text-sm mb-1\">Tên *</label>\r\n+              <input\r\n+                name=\"firstName\"\r\n+                type=\"text\"\r\n+                value={formData.firstName}\r\n+                onChange={handleInputChange}\r\n+                className={`w-full px-3 py-2 border rounded-md ${errors.firstName ? 'border-red-500' : 'border-gray-300'}`}\r\n+                required\r\n+              />\r\n+            </div>\r\n+            <div>\r\n+              <label className=\"block text-sm mb-1\">Họ *</label>\r\n+              <input\r\n+                name=\"lastName\"\r\n+                type=\"text\"\r\n+                value={formData.lastName}\r\n+                onChange={handleInputChange}\r\n+                className={`w-full px-3 py-2 border rounded-md ${errors.lastName ? 'border-red-500' : 'border-gray-300'}`}\r\n+                required\r\n+              />\r\n+            </div>\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Số điện thoại *</label>\r\n+            <input\r\n+              name=\"phone\"\r\n+              type=\"tel\"\r\n+              value={formData.phone}\r\n+              onChange={handleInputChange}\r\n+              className={`w-full px-3 py-2 border rounded-md ${errors.phone ? 'border-red-500' : 'border-gray-300'}`}\r\n+              required\r\n+            />\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Số điện thoại phụ (không bắt buộc)</label>\r\n+            <input\r\n+              name=\"additionalPhone\"\r\n+              type=\"tel\"\r\n+              value={formData.additionalPhone}\r\n+              onChange={handleInputChange}\r\n+              className=\"w-full px-3 py-2 border border-gray-300 rounded-md\"\r\n+            />\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Tỉnh/Thành phố *</label>\r\n+            <select\r\n+              value={selectedProvince}\r\n+              onChange={handleProvinceChange}\r\n+              className={`w-full px-3 py-2 border rounded-md ${errors.province ? 'border-red-500' : 'border-gray-300'}`}\r\n+              required\r\n+            >\r\n+              <option value=\"\">Chọn tỉnh/thành phố</option>\r\n+              {provinces.map((province) => (\r\n+                <option key={province.code} value={province.code}>\r\n+                  {province.name}\r\n+                </option>\r\n+              ))}\r\n+            </select>\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Quận/Huyện *</label>\r\n+            <select\r\n+              value={selectedDistrict}\r\n+              onChange={handleDistrictChange}\r\n+              className={`w-full px-3 py-2 border rounded-md ${errors.district ? 'border-red-500' : 'border-gray-300'}`}\r\n+              required\r\n+              disabled={!selectedProvince}\r\n+            >\r\n+              <option value=\"\">Chọn quận/huyện</option>\r\n+              {districts.map((district) => (\r\n+                <option key={district.code} value={district.code}>\r\n+                  {district.name}\r\n+                </option>\r\n+              ))}\r\n+            </select>\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Phường/Xã *</label>\r\n+            <select\r\n+              value={selectedWard}\r\n+              onChange={handleWardChange}\r\n+              className={`w-full px-3 py-2 border rounded-md ${errors.ward ? 'border-red-500' : 'border-gray-300'}`}\r\n+              required\r\n+              disabled={!selectedDistrict}\r\n+            >\r\n+              <option value=\"\">Chọn phường/xã</option>\r\n+              {wards.map((ward) => (\r\n+                <option key={ward.code} value={ward.code}>\r\n+                  {ward.name}\r\n+                </option>\r\n+              ))}\r\n+            </select>\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Địa chỉ *</label>\r\n+            <input\r\n+              name=\"address\"\r\n+              type=\"text\"\r\n+              value={formData.address}\r\n+              onChange={handleInputChange}\r\n+              className={`w-full px-3 py-2 border rounded-md ${errors.address ? 'border-red-500' : 'border-gray-300'}`}\r\n+              required\r\n+            />\r\n+          </div>\r\n+\r\n+          <div>\r\n+            <label className=\"block text-sm mb-1\">Số nhà, tên đường (không bắt buộc)</label>\r\n+            <input\r\n+              name=\"apartment\"\r\n+              type=\"text\"\r\n+              value={formData.apartment}\r\n+              onChange={handleInputChange}\r\n+              className=\"w-full px-3 py-2 border border-gray-300 rounded-md\"\r\n+            />\r\n+          </div>\r\n+\r\n+          <div className=\"flex justify-end\">\r\n+            <button\r\n+              type=\"button\"\r\n+              onClick={handleContinueToPayment}\r\n+              className=\"bg-black text-white px-6 py-2 rounded-md hover:bg-gray-800 transition-colors\"\r\n+            >\r\n+              Tiếp tục\r\n+            </button>\r\n+          </div>\r\n+        </form>\r\n+      </div>\r\n+\r\n+      {showPaymentSection && (\r\n+        <div id=\"paymentSection\" className=\"mb-8\">\r\n+          <h2 className=\"text-lg font-semibold mb-3\">PHƯƠNG THỨC THANH TOÁN</h2>\r\n+          <div className=\"space-y-4\">\r\n+            <div className=\"flex items-center\">\r\n+              <input\r\n+                type=\"radio\"\r\n+                id=\"cod\"\r\n+                name=\"paymentMethod\"\r\n+                value=\"cod\"\r\n+                checked={paymentMethod === \"cod\"}\r\n+                onChange={() => handlePaymentMethodChange(\"cod\")}\r\n+                className=\"mr-2\"\r\n+              />\r\n+              <label htmlFor=\"cod\" className=\"text-sm\">\r\n+                Thanh toán khi nhận hàng (COD)\r\n+              </label>\r\n+            </div>\r\n+            <div className=\"flex items-center\">\r\n+              <input\r\n+                type=\"radio\"\r\n+                id=\"bank\"\r\n+                name=\"paymentMethod\"\r\n+                value=\"bank\"\r\n+                checked={paymentMethod === \"bank\"}\r\n+                onChange={() => handlePaymentMethodChange(\"bank\")}\r\n+                className=\"mr-2\"\r\n+              />\r\n+              <label htmlFor=\"bank\" className=\"text-sm\">\r\n+                Chuyển khoản ngân hàng\r\n+              </label>\r\n+            </div>\r\n+            {renderPaymentInfo()}\r\n+          </div>\r\n+\r\n+          <div className=\"mt-6\">\r\n+            <button\r\n+              onClick={handleCompleteOrder}\r\n+              className=\"w-full bg-black text-white px-6 py-3 rounded-md hover:bg-gray-800 transition-colors\"\r\n+            >\r\n+              Hoàn tất đơn hàng\r\n+            </button>\r\n+          </div>\r\n+        </div>\r\n+      )}\r\n+\r\n+      {showConfirmationModal && orderDetails && (\r\n+        <OrderConfirmationModal\r\n+          orderDetails={orderDetails}\r\n+          onClose={() => setShowConfirmationModal(false)}\r\n+          onConfirm={async () => {\r\n+            try {\r\n+              const response = await fetch('/api/orders', {\r\n+                method: 'POST',\r\n+                headers: {\r\n+                  'Content-Type': 'application/json',\r\n+                },\r\n+                body: JSON.stringify(orderDetails),\r\n+              });\r\n+\r\n+              if (!response.ok) {\r\n+                throw new Error('Failed to create order');\r\n+              }\r\n+\r\n+              const data = await response.json();\r\n+              if (data.ok) {\r\n+                toast.success('Đặt hàng thành công!');\r\n+                router.push(`/order-success/${orderDetails.orderNumber}`);\r\n+              } else {\r\n+                throw new Error(data.message || 'Failed to create order');\r\n+              }\r\n+            } catch (error) {\r\n+              console.error('Error creating order:', error);\r\n+              toast.error('Có lỗi xảy ra khi tạo đơn hàng. Vui lòng thử lại.');\r\n+            }\r\n+          }}\r\n+        />\r\n+      )}\r\n+    </div>\r\n+  );\r\n+} \n\\ No newline at end of file\n"
                },
                {
                    "date": 1747804908984,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1 +1,88 @@\n- \n\\ No newline at end of file\n+const handleCompleteOrder = async (e) => {\r\n+  e.preventDefault();\r\n+  \r\n+  try {\r\n+    if (!selectedProvince || !selectedDistrict || !selectedWard) {\r\n+      toast.error(\"Vui lòng chọn đầy đủ thông tin địa chỉ\");\r\n+      return;\r\n+    }\r\n+\r\n+    if (!formData.firstName || !formData.lastName || !formData.phone) {\r\n+      toast.error(\"Vui lòng điền đầy đủ thông tin bắt buộc\");\r\n+      return;\r\n+    }\r\n+\r\n+    const now = new Date();\r\n+    const orderNumber = `AISH${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;\r\n+\r\n+    const subtotal = order.items.reduce((total, item) => {\r\n+      const priceStr = typeof item.price === 'string' ? item.price.replace('AU$', '').trim() : item.price;\r\n+      const price = parseFloat(priceStr) || 0;\r\n+      return total + (price * item.quantity);\r\n+    }, 0);\r\n+\r\n+    const details = {\r\n+      orderNumber: orderNumber,\r\n+      fullName: `${formData.firstName} ${formData.lastName}`,\r\n+      email: userEmail,\r\n+      phone: formData.phone,\r\n+      additionalPhone: formData.additionalPhone || null,\r\n+      apartment: formData.apartment || null,\r\n+      ward: selectedWardName || \"\",\r\n+      district: selectedDistrictName || \"\",\r\n+      province: selectedProvinceName || \"\",\r\n+      items: order.items.map(item => ({\r\n+        ...item,\r\n+        price: typeof item.price === 'string' ? parseFloat(item.price.replace('AU$', '').trim()) : item.price\r\n+      })),\r\n+      subtotal: subtotal,\r\n+      shippingFee: \"Free\",\r\n+      promoCode: order.promoCode || null,\r\n+      promoAmount: order.promoAmount || 0,\r\n+      total: subtotal - (order.promoAmount || 0),\r\n+      paymentMethod: paymentMethod,\r\n+      status: 'pending',\r\n+      paymentStatus: 'pending',\r\n+      shippingStatus: 'pending'\r\n+    };\r\n+\r\n+    setOrderDetails(details);\r\n+    setShowConfirmationModal(true);\r\n+  } catch (error) {\r\n+    console.error(\"Error preparing order:\", error);\r\n+    toast.error(\"Có lỗi xảy ra khi chuẩn bị đơn hàng. Vui lòng thử lại.\");\r\n+  }\r\n+};\r\n+\r\n+{showConfirmationModal && orderDetails && (\r\n+  <OrderConfirmationModal\r\n+    orderDetails={orderDetails}\r\n+    onClose={() => setShowConfirmationModal(false)}\r\n+    onConfirm={async () => {\r\n+      try {\r\n+        const response = await fetch('/api/orders', {\r\n+          method: 'POST',\r\n+          headers: {\r\n+            'Content-Type': 'application/json',\r\n+          },\r\n+          body: JSON.stringify(orderDetails),\r\n+        });\r\n+\r\n+        if (!response.ok) {\r\n+          throw new Error('Failed to create order');\r\n+        }\r\n+\r\n+        const data = await response.json();\r\n+        if (data.ok) {\r\n+          toast.success('Đặt hàng thành công!');\r\n+          router.push(`/order-success/${orderDetails.orderNumber}`);\r\n+        } else {\r\n+          throw new Error(data.message || 'Failed to create order');\r\n+        }\r\n+      } catch (error) {\r\n+        console.error('Error creating order:', error);\r\n+        toast.error('Có lỗi xảy ra khi tạo đơn hàng. Vui lòng thử lại.');\r\n+      }\r\n+    }}\r\n+  />\r\n+)} \n\\ No newline at end of file\n"
                }
            ],
            "date": 1747800084344,
            "name": "Commit-0",
            "content": "\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { useVietnameseAddress } from \"@/hooks/useVietnameseAddress\";\r\nimport OrderConfirmationModal from \"@/components/OrderConfirmationModal\";\r\n\r\nexport default function ShippingPage({\r\n  userEmail: propUserEmail,\r\n  isShippingComplete,\r\n  showAdditionalContact,\r\n  showPaymentDetails,\r\n  errors,\r\n  handleShippingComplete,\r\n  handleAdditionalContactToggle,\r\n  order,\r\n}) {\r\n  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n  const [showPaymentSection, setShowPaymentSection] = useState(false);\r\n  const [showConfirmationModal, setShowConfirmationModal] = useState(false);\r\n  const [orderDetails, setOrderDetails] = useState(null);\r\n  const [localUserEmail, setLocalUserEmail] = useState(\"\");\r\n  const [formData, setFormData] = useState({\r\n    firstName: \"\",\r\n    lastName: \"\",\r\n    address: \"\",\r\n    phone: \"\",\r\n    additionalPhone: \"\",\r\n    apartment: \"\",\r\n  });\r\n\r\n  const {\r\n    provinces,\r\n    districts,\r\n    wards,\r\n    selectedProvince,\r\n    selectedDistrict,\r\n    selectedWard,\r\n    selectedProvinceName,\r\n    selectedDistrictName,\r\n    selectedWardName,\r\n    handleProvinceChange,\r\n    handleDistrictChange,\r\n    handleWardChange\r\n  } = useVietnameseAddress();\r\n\r\n  useEffect(() => {\r\n    const email = localStorage.getItem('userEmail') || sessionStorage.getItem('userEmail');\r\n    if (email) {\r\n      setLocalUserEmail(email);\r\n    }\r\n  }, []);\r\n\r\n  const userEmail = propUserEmail || localUserEmail;\r\n\r\n  const handleInputChange = (e) => {\r\n    const { name, value } = e.target;\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      [name]: value\r\n    }));\r\n  };\r\n\r\n  const handleContinueToPayment = (e) => {\r\n    e.preventDefault();\r\n    const shippingForm = document.getElementById('shippingForm');\r\n    if (shippingForm.checkValidity()) {\r\n      setShowPaymentSection(true);\r\n      const paymentSection = document.getElementById('paymentSection');\r\n      if (paymentSection) {\r\n        paymentSection.scrollIntoView({ behavior: 'smooth' });\r\n      }\r\n    } else {\r\n      shippingForm.reportValidity();\r\n    }\r\n  };\r\n\r\n  const handleCompleteOrder = async (e) => {\r\n    e.preventDefault();\r\n    \r\n    try {\r\n      if (!selectedProvince || !selectedDistrict || !selectedWard) {\r\n        toast.error(\"Vui lòng chọn đầy đủ thông tin địa chỉ\");\r\n        return;\r\n      }\r\n\r\n      if (!formData.firstName || !formData.lastName || !formData.phone) {\r\n        toast.error(\"Vui lòng điền đầy đủ thông tin bắt buộc\");\r\n        return;\r\n      }\r\n\r\n      const now = new Date();\r\n      const orderCode = `AISH${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;\r\n\r\n      const subtotal = order.items.reduce((total, item) => {\r\n        const priceStr = typeof item.price === 'string' ? item.price.replace('AU$', '').trim() : item.price;\r\n        const price = parseFloat(priceStr) || 0;\r\n        return total + (price * item.quantity);\r\n      }, 0);\r\n\r\n      const details = {\r\n        orderCode: orderCode,\r\n        fullName: `${formData.firstName} ${formData.lastName}`,\r\n        email: userEmail,\r\n        phone: formData.phone,\r\n        additionalPhone: formData.additionalPhone || null,\r\n        apartment: formData.apartment || null,\r\n        ward: selectedWardName || \"\",\r\n        district: selectedDistrictName || \"\",\r\n        province: selectedProvinceName || \"\",\r\n        items: order.items.map(item => ({\r\n          ...item,\r\n          price: typeof item.price === 'string' ? parseFloat(item.price.replace('AU$', '').trim()) : item.price\r\n        })),\r\n        subtotal: subtotal,\r\n        shippingFee: \"Free\",\r\n        promoCode: order.promoCode || null,\r\n        promoAmount: order.promoAmount || 0,\r\n        total: subtotal - (order.promoAmount || 0),\r\n        paymentMethod: paymentMethod,\r\n        status: 'pending',\r\n        paymentStatus: 'pending',\r\n        shippingStatus: 'pending'\r\n      };\r\n\r\n      setOrderDetails(details);\r\n      setShowConfirmationModal(true);\r\n    } catch (error) {\r\n      console.error(\"Error preparing order:\", error);\r\n      toast.error(\"Có lỗi xảy ra khi chuẩn bị đơn hàng. Vui lòng thử lại.\");\r\n    }\r\n  };\r\n\r\n  const handlePaymentMethodChange = (method) => {\r\n    setPaymentMethod(method);\r\n  };\r\n\r\n  const renderPaymentInfo = () => {\r\n    if (!paymentMethod) return null;\r\n\r\n    if (paymentMethod === 'cod') {\r\n      return (\r\n        <div className=\"mt-5 p-4 bg-gray-50 rounded-md\">\r\n          <p className=\"text-sm text-gray-600 italic\">\r\n            Quý khách ghi nhớ mã đơn hàng và nhắn tin cho Facebook hoặc Instagram aish.aish.vn nếu muốn tra cứu mã vận đơn nhé\r\n          </p>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    if (paymentMethod === 'bank') {\r\n      return (\r\n        <div className=\"mt-5 p-4 bg-gray-50 rounded-md\">\r\n          <h3 className=\"text-sm font-semibold mb-3\">\r\n            Thông tin chuyển khoản\r\n          </h3>\r\n          <div className=\"text-sm space-y-2\">\r\n            <p>Ngân hàng: MB BANK</p>\r\n            <p>Chủ tài khoản: PHAN THUY TRUC DAO</p>\r\n            <p>Số tài khoản: 024052306</p>\r\n            <p>Nội dung chuyển khoản: MÃ ĐƠN HÀNG + SĐT</p>\r\n            <p className=\"mt-4 text-gray-600 italic\">\r\n              Sau khi đặt hàng thành công, quý khách sẽ thấy mã đơn hàng tại trang. Quý khách vui lòng chuyển khoản đúng nội dung và chụp màn hình gửi về Facebook hoặc Instagram aish.aish.vn nhaa\r\n            </p>\r\n          </div>\r\n        </div>\r\n      );\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex-1 bg-white p-6 border border-gray-200\">\r\n      <div className=\"mb-8\">\r\n        <h2 className=\"text-lg font-semibold mb-3\">THÔNG TIN LIÊN HỆ</h2>\r\n        <p className=\"text-sm\">\r\n          {userEmail ? (\r\n            <>\r\n              {userEmail} (<Link href=\"/logout\" className=\"underline hover:text-gray-600\">Đăng xuất</Link>)\r\n            </>\r\n          ) : (\r\n            \"Bạn chưa đăng nhập\"\r\n          )}\r\n        </p>\r\n      </div>\r\n\r\n      <div className=\"mb-8\">\r\n        <h2 className=\"text-lg font-semibold mb-3\">ĐỊA CHỈ GIAO HÀNG</h2>\r\n        <form id=\"shippingForm\" className=\"space-y-4\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div>\r\n              <label className=\"block text-sm mb-1\">Tên *</label>\r\n              <input\r\n                name=\"firstName\"\r\n                type=\"text\"\r\n                value={formData.firstName}\r\n                onChange={handleInputChange}\r\n                className={`w-full px-3 py-2 border rounded-md ${errors.firstName ? 'border-red-500' : 'border-gray-300'}`}\r\n                required\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm mb-1\">Họ *</label>\r\n              <input\r\n                name=\"lastName\"\r\n                type=\"text\"\r\n                value={formData.lastName}\r\n                onChange={handleInputChange}\r\n                className={`w-full px-3 py-2 border rounded-md ${errors.lastName ? 'border-red-500' : 'border-gray-300'}`}\r\n                required\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div>\r\n            <label className=\"block text-sm mb-1\">Số nhà, tên đường (tùy chọn)</label>\r\n            <input\r\n              name=\"apartment\"\r\n              type=\"text\"\r\n              value={formData.apartment}\r\n              onChange={handleInputChange}\r\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md\"\r\n            />\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div>\r\n              <label className=\"block text-sm mb-1\">Tỉnh/Thành phố *</label>\r\n              <select\r\n                value={selectedProvince}\r\n                onChange={handleProvinceChange}\r\n                className={`w-full px-3 py-2 border rounded-md ${errors.province ? 'border-red-500' : 'border-gray-300'}`}\r\n                required\r\n              >\r\n                <option value=\"\">Chọn Tỉnh/Thành phố</option>\r\n                {provinces.map((province) => (\r\n                  <option key={province.code} value={province.code}>\r\n                    {province.name}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm mb-1\">Quận/Huyện *</label>\r\n              <select\r\n                value={selectedDistrict}\r\n                onChange={handleDistrictChange}\r\n                className={`w-full px-3 py-2 border rounded-md ${errors.district ? 'border-red-500' : 'border-gray-300'}`}\r\n                required\r\n                disabled={!selectedProvince}\r\n              >\r\n                <option value=\"\">Chọn Quận/Huyện</option>\r\n                {districts.map((district) => (\r\n                  <option key={district.code} value={district.code}>\r\n                    {district.name}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div>\r\n              <label className=\"block text-sm mb-1\">Phường/Xã *</label>\r\n              <select\r\n                value={selectedWard}\r\n                onChange={handleWardChange}\r\n                className={`w-full px-3 py-2 border rounded-md ${errors.ward ? 'border-red-500' : 'border-gray-300'}`}\r\n                required\r\n                disabled={!selectedDistrict}\r\n              >\r\n                <option value=\"\">Chọn Phường/Xã</option>\r\n                {wards.map((ward) => (\r\n                  <option key={ward.code} value={ward.code}>\r\n                    {ward.name}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm mb-1\">Số điện thoại *</label>\r\n              <input\r\n                name=\"phone\"\r\n                type=\"tel\"\r\n                value={formData.phone}\r\n                onChange={handleInputChange}\r\n                className={`w-full px-3 py-2 border rounded-md ${errors.phone ? 'border-red-500' : 'border-gray-300'}`}\r\n                required\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {showAdditionalContact && (\r\n            <div>\r\n              <label className=\"block text-sm mb-1\">Số điện thoại phụ (tùy chọn)</label>\r\n              <input\r\n                name=\"additionalPhone\"\r\n                type=\"tel\"\r\n                value={formData.additionalPhone}\r\n                onChange={handleInputChange}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md\"\r\n              />\r\n            </div>\r\n          )}\r\n\r\n          <input type=\"hidden\" name=\"ward\" value={selectedWardName} />\r\n          <input type=\"hidden\" name=\"district\" value={selectedDistrictName} />\r\n          <input type=\"hidden\" name=\"province\" value={selectedProvinceName} />\r\n\r\n          <button\r\n            onClick={handleContinueToPayment}\r\n            className=\"w-full bg-black text-white py-3 px-4 rounded-md hover:bg-gray-800 transition-colors uppercase text-sm font-medium\"\r\n            type=\"submit\"\r\n          >\r\n            Tiếp tục thanh toán\r\n          </button>\r\n        </form>\r\n      </div>\r\n\r\n      {showPaymentSection && (\r\n        <div id=\"paymentSection\" className=\"mb-8\">\r\n          <h2 className=\"text-lg font-semibold mb-3\">PHƯƠNG THỨC THANH TOÁN</h2>\r\n          <div className=\"space-y-4\">\r\n            <div\r\n              className={`p-4 border rounded-md cursor-pointer transition-colors ${\r\n                paymentMethod === \"cod\" ? \"border-black\" : \"border-gray-300\"\r\n              }`}\r\n              onClick={() => handlePaymentMethodChange(\"cod\")}\r\n            >\r\n              <div className=\"flex items-center gap-3\">\r\n                <input\r\n                  type=\"radio\"\r\n                  name=\"paymentMethod\"\r\n                  checked={paymentMethod === \"cod\"}\r\n                  onChange={() => handlePaymentMethodChange(\"cod\")}\r\n                  className=\"w-4 h-4\"\r\n                />\r\n                <label className=\"text-sm font-medium\">\r\n                  Thanh toán khi nhận hàng (COD)\r\n                </label>\r\n              </div>\r\n            </div>\r\n\r\n            <div\r\n              className={`p-4 border rounded-md cursor-pointer transition-colors ${\r\n                paymentMethod === \"bank\" ? \"border-black\" : \"border-gray-300\"\r\n              }`}\r\n              onClick={() => handlePaymentMethodChange(\"bank\")}\r\n            >\r\n              <div className=\"flex items-center gap-3\">\r\n                <input\r\n                  type=\"radio\"\r\n                  name=\"paymentMethod\"\r\n                  checked={paymentMethod === \"bank\"}\r\n                  onChange={() => handlePaymentMethodChange(\"bank\")}\r\n                  className=\"w-4 h-4\"\r\n                />\r\n                <label className=\"text-sm font-medium\">\r\n                  Chuyển khoản ngân hàng\r\n                </label>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {renderPaymentInfo()}\r\n\r\n          {paymentMethod && (\r\n            <button\r\n              onClick={handleCompleteOrder}\r\n              className=\"w-full bg-black text-white py-3 px-4 rounded-md hover:bg-gray-800 transition-colors uppercase text-sm font-medium mt-6\"\r\n            >\r\n              Hoàn tất đơn hàng\r\n            </button>\r\n          )}\r\n        </div>\r\n      )}\r\n\r\n      <OrderConfirmationModal\r\n        isOpen={showConfirmationModal}\r\n        onClose={() => setShowConfirmationModal(false)}\r\n        orderDetails={orderDetails}\r\n      />\r\n    </div>\r\n  );\r\n} "
        }
    ]
}