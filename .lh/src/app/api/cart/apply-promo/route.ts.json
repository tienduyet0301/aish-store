{
    "sourceFile": "src/app/api/cart/apply-promo/route.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 39,
            "patches": [
                {
                    "date": 1749534526144,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1749534539579,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -53,10 +53,11 @@\n     }\r\n \r\n     // Kiểm tra giới hạn sử dụng cho mỗi người dùng\r\n     if (promo.isLoginRequired && session?.user?.email && promo.perUserLimit > 0) {\r\n+      const userEmail = session.user.email;\r\n       const userUsageCount = promo.usedByUsers?.filter(\r\n-        (user: { email: string; count: number }) => user.email === session.user.email\r\n+        (user: { email: string; count: number }) => user.email === userEmail\r\n       ).reduce((total: number, user: { count: number }) => total + user.count, 0) || 0;\r\n \r\n       if (userUsageCount >= promo.perUserLimit) {\r\n         return NextResponse.json(\r\n"
                },
                {
                    "date": 1749536742336,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,8 +11,10 @@\n     const session = await getServerSession(authOptions);\r\n     const { db } = await connectToDatabase();\r\n     const { promoCode, cartItems } = await request.json();\r\n \r\n+    console.log('Applying promo code:', { promoCode, cartItems }); // Debug log\r\n+\r\n     if (!promoCode || !cartItems || !Array.isArray(cartItems)) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Invalid request data' },\r\n         { status: 400 }\r\n@@ -20,8 +22,9 @@\n     }\r\n \r\n     // Tìm mã giảm giá\r\n     const promo = await db.collection('promoCodes').findOne({ code: promoCode });\r\n+    console.log('Found promo code:', promo); // Debug log\r\n \r\n     if (!promo) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Mã giảm giá không tồn tại' },\r\n@@ -90,8 +93,10 @@\n         discount: itemDiscount\r\n       };\r\n     });\r\n \r\n+    console.log('Applied discounts:', { updatedCartItems, totalDiscount }); // Debug log\r\n+\r\n     return NextResponse.json({\r\n       ok: true,\r\n       message: 'Áp dụng mã giảm giá thành công',\r\n       cartItems: updatedCartItems,\r\n"
                },
                {
                    "date": 1749536784947,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,10 +11,8 @@\n     const session = await getServerSession(authOptions);\r\n     const { db } = await connectToDatabase();\r\n     const { promoCode, cartItems } = await request.json();\r\n \r\n-    console.log('Applying promo code:', { promoCode, cartItems }); // Debug log\r\n-\r\n     if (!promoCode || !cartItems || !Array.isArray(cartItems)) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Invalid request data' },\r\n         { status: 400 }\r\n@@ -22,9 +20,8 @@\n     }\r\n \r\n     // Tìm mã giảm giá\r\n     const promo = await db.collection('promoCodes').findOne({ code: promoCode });\r\n-    console.log('Found promo code:', promo); // Debug log\r\n \r\n     if (!promo) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Mã giảm giá không tồn tại' },\r\n@@ -93,10 +90,8 @@\n         discount: itemDiscount\r\n       };\r\n     });\r\n \r\n-    console.log('Applied discounts:', { updatedCartItems, totalDiscount }); // Debug log\r\n-\r\n     return NextResponse.json({\r\n       ok: true,\r\n       message: 'Áp dụng mã giảm giá thành công',\r\n       cartItems: updatedCartItems,\r\n"
                },
                {
                    "date": 1749536822651,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,8 +11,10 @@\n     const session = await getServerSession(authOptions);\r\n     const { db } = await connectToDatabase();\r\n     const { promoCode, cartItems } = await request.json();\r\n \r\n+    console.log('Applying promo code:', { promoCode, cartItems }); // Debug log\r\n+\r\n     if (!promoCode || !cartItems || !Array.isArray(cartItems)) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Invalid request data' },\r\n         { status: 400 }\r\n@@ -20,33 +22,44 @@\n     }\r\n \r\n     // Tìm mã giảm giá\r\n     const promo = await db.collection('promoCodes').findOne({ code: promoCode });\r\n+    console.log('Found promo code:', promo); // Debug log\r\n \r\n     if (!promo) {\r\n+      console.log('Promo code not found:', promoCode); // Debug log\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Mã giảm giá không tồn tại' },\r\n         { status: 404 }\r\n       );\r\n     }\r\n \r\n     if (!promo.isActive) {\r\n+      console.log('Promo code is inactive'); // Debug log\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Mã giảm giá đã bị vô hiệu hóa' },\r\n         { status: 400 }\r\n       );\r\n     }\r\n \r\n     // Kiểm tra ngày hết hạn\r\n-    if (promo.expiryDate && new Date() > new Date(promo.expiryDate)) {\r\n-      return NextResponse.json(\r\n-        { ok: false, message: 'Mã giảm giá đã hết hạn' },\r\n-        { status: 400 }\r\n-      );\r\n+    if (promo.expiryDate) {\r\n+      const expiryDate = new Date(promo.expiryDate);\r\n+      const now = new Date();\r\n+      console.log('Checking expiry date:', { expiryDate, now }); // Debug log\r\n+      \r\n+      if (now > expiryDate) {\r\n+        console.log('Promo code has expired'); // Debug log\r\n+        return NextResponse.json(\r\n+          { ok: false, message: 'Mã giảm giá đã hết hạn' },\r\n+          { status: 400 }\r\n+        );\r\n+      }\r\n     }\r\n \r\n     // Kiểm tra yêu cầu đăng nhập\r\n     if (promo.isLoginRequired && !session?.user?.email) {\r\n+      console.log('Login required but no session'); // Debug log\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Vui lòng đăng nhập để sử dụng mã giảm giá này' },\r\n         { status: 401 }\r\n       );\r\n@@ -58,8 +71,10 @@\n       const userUsageCount = promo.usedByUsers?.filter(\r\n         (user: { email: string; count: number }) => user.email === userEmail\r\n       ).reduce((total: number, user: { count: number }) => total + user.count, 0) || 0;\r\n \r\n+      console.log('Checking user limit:', { userEmail, userUsageCount, perUserLimit: promo.perUserLimit }); // Debug log\r\n+\r\n       if (userUsageCount >= promo.perUserLimit) {\r\n         return NextResponse.json(\r\n           { ok: false, message: 'Bạn đã sử dụng hết số lần cho phép của mã giảm giá này' },\r\n           { status: 400 }\r\n@@ -72,9 +87,17 @@\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n-      if (promo.scope === 'all' || (promo.scope === 'selected' && promo.selectedProducts?.includes(item.id))) {\r\n+      const isApplicable = promo.scope === 'all' || (promo.scope === 'selected' && promo.selectedProducts?.includes(item.id));\r\n+      console.log('Checking item applicability:', { \r\n+        itemId: item.id, \r\n+        scope: promo.scope, \r\n+        selectedProducts: promo.selectedProducts,\r\n+        isApplicable \r\n+      }); // Debug log\r\n+\r\n+      if (isApplicable) {\r\n         if (promo.type === 'fixed') {\r\n           itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n         } else {\r\n           const percentageDiscount = (item.price * item.quantity * promo.value) / 100;\r\n@@ -90,8 +113,10 @@\n         discount: itemDiscount\r\n       };\r\n     });\r\n \r\n+    console.log('Applied discounts:', { updatedCartItems, totalDiscount }); // Debug log\r\n+\r\n     return NextResponse.json({\r\n       ok: true,\r\n       message: 'Áp dụng mã giảm giá thành công',\r\n       cartItems: updatedCartItems,\r\n"
                },
                {
                    "date": 1749540211481,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -87,11 +87,16 @@\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n-      const isApplicable = promo.scope === 'all' || (promo.scope === 'selected' && promo.selectedProducts?.includes(item.id));\r\n+      const isApplicable = promo.scope === 'all' || \r\n+        (promo.scope === 'selected' && \r\n+          (promo.selectedProducts?.includes(item.id) || \r\n+           promo.selectedProducts?.includes(item.productId)));\r\n+\r\n       console.log('Checking item applicability:', { \r\n-        itemId: item.id, \r\n+        itemId: item.id,\r\n+        productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n         isApplicable \r\n       }); // Debug log\r\n@@ -109,9 +114,10 @@\n \r\n       totalDiscount += itemDiscount;\r\n       return {\r\n         ...item,\r\n-        discount: itemDiscount\r\n+        discount: itemDiscount,\r\n+        isPromoApplied: isApplicable // Thêm flag để biết sản phẩm có được áp dụng mã giảm giá không\r\n       };\r\n     });\r\n \r\n     console.log('Applied discounts:', { updatedCartItems, totalDiscount }); // Debug log\r\n"
                },
                {
                    "date": 1749540380217,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -97,31 +97,61 @@\n         itemId: item.id,\r\n         productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n-        isApplicable \r\n+        isApplicable,\r\n+        itemPrice: item.price,\r\n+        itemQuantity: item.quantity,\r\n+        promoType: promo.type,\r\n+        promoValue: promo.value,\r\n+        promoMaxAmount: promo.maxAmount\r\n       }); // Debug log\r\n \r\n       if (isApplicable) {\r\n         if (promo.type === 'fixed') {\r\n           itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n+          console.log('Fixed discount calculation:', {\r\n+            promoValue: promo.value,\r\n+            itemTotal: item.price * item.quantity,\r\n+            calculatedDiscount: itemDiscount\r\n+          });\r\n         } else {\r\n           const percentageDiscount = (item.price * item.quantity * promo.value) / 100;\r\n           itemDiscount = promo.maxAmount \r\n             ? Math.min(percentageDiscount, promo.maxAmount)\r\n             : percentageDiscount;\r\n+          console.log('Percentage discount calculation:', {\r\n+            itemTotal: item.price * item.quantity,\r\n+            percentage: promo.value,\r\n+            calculatedPercentage: percentageDiscount,\r\n+            maxAmount: promo.maxAmount,\r\n+            finalDiscount: itemDiscount\r\n+          });\r\n         }\r\n       }\r\n \r\n       totalDiscount += itemDiscount;\r\n       return {\r\n         ...item,\r\n         discount: itemDiscount,\r\n-        isPromoApplied: isApplicable // Thêm flag để biết sản phẩm có được áp dụng mã giảm giá không\r\n+        isPromoApplied: isApplicable,\r\n+        originalPrice: item.price * item.quantity,\r\n+        finalPrice: (item.price * item.quantity) - itemDiscount\r\n       };\r\n     });\r\n \r\n-    console.log('Applied discounts:', { updatedCartItems, totalDiscount }); // Debug log\r\n+    console.log('Applied discounts:', { \r\n+      updatedCartItems, \r\n+      totalDiscount,\r\n+      promoDetails: {\r\n+        code: promo.code,\r\n+        type: promo.type,\r\n+        value: promo.value,\r\n+        maxAmount: promo.maxAmount,\r\n+        scope: promo.scope,\r\n+        selectedProducts: promo.selectedProducts\r\n+      }\r\n+    }); // Debug log\r\n \r\n     return NextResponse.json({\r\n       ok: true,\r\n       message: 'Áp dụng mã giảm giá thành công',\r\n"
                },
                {
                    "date": 1749540829130,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -87,71 +87,35 @@\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n-      const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && \r\n-          (promo.selectedProducts?.includes(item.id) || \r\n-           promo.selectedProducts?.includes(item.productId)));\r\n-\r\n+      const isApplicable = promo.scope === 'all' || (promo.scope === 'selected' && promo.selectedProducts?.includes(item.id));\r\n       console.log('Checking item applicability:', { \r\n-        itemId: item.id,\r\n-        productId: item.productId,\r\n+        itemId: item.id, \r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n-        isApplicable,\r\n-        itemPrice: item.price,\r\n-        itemQuantity: item.quantity,\r\n-        promoType: promo.type,\r\n-        promoValue: promo.value,\r\n-        promoMaxAmount: promo.maxAmount\r\n+        isApplicable \r\n       }); // Debug log\r\n \r\n       if (isApplicable) {\r\n         if (promo.type === 'fixed') {\r\n           itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n-          console.log('Fixed discount calculation:', {\r\n-            promoValue: promo.value,\r\n-            itemTotal: item.price * item.quantity,\r\n-            calculatedDiscount: itemDiscount\r\n-          });\r\n         } else {\r\n           const percentageDiscount = (item.price * item.quantity * promo.value) / 100;\r\n           itemDiscount = promo.maxAmount \r\n             ? Math.min(percentageDiscount, promo.maxAmount)\r\n             : percentageDiscount;\r\n-          console.log('Percentage discount calculation:', {\r\n-            itemTotal: item.price * item.quantity,\r\n-            percentage: promo.value,\r\n-            calculatedPercentage: percentageDiscount,\r\n-            maxAmount: promo.maxAmount,\r\n-            finalDiscount: itemDiscount\r\n-          });\r\n         }\r\n       }\r\n \r\n       totalDiscount += itemDiscount;\r\n       return {\r\n         ...item,\r\n-        discount: itemDiscount,\r\n-        isPromoApplied: isApplicable,\r\n-        originalPrice: item.price * item.quantity,\r\n-        finalPrice: (item.price * item.quantity) - itemDiscount\r\n+        discount: itemDiscount\r\n       };\r\n     });\r\n \r\n-    console.log('Applied discounts:', { \r\n-      updatedCartItems, \r\n-      totalDiscount,\r\n-      promoDetails: {\r\n-        code: promo.code,\r\n-        type: promo.type,\r\n-        value: promo.value,\r\n-        maxAmount: promo.maxAmount,\r\n-        scope: promo.scope,\r\n-        selectedProducts: promo.selectedProducts\r\n-      }\r\n-    }); // Debug log\r\n+    console.log('Applied discounts:', { updatedCartItems, totalDiscount }); // Debug log\r\n \r\n     return NextResponse.json({\r\n       ok: true,\r\n       message: 'Áp dụng mã giảm giá thành công',\r\n"
                },
                {
                    "date": 1749540849742,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,10 +11,8 @@\n     const session = await getServerSession(authOptions);\r\n     const { db } = await connectToDatabase();\r\n     const { promoCode, cartItems } = await request.json();\r\n \r\n-    console.log('Applying promo code:', { promoCode, cartItems }); // Debug log\r\n-\r\n     if (!promoCode || !cartItems || !Array.isArray(cartItems)) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Invalid request data' },\r\n         { status: 400 }\r\n@@ -22,44 +20,33 @@\n     }\r\n \r\n     // Tìm mã giảm giá\r\n     const promo = await db.collection('promoCodes').findOne({ code: promoCode });\r\n-    console.log('Found promo code:', promo); // Debug log\r\n \r\n     if (!promo) {\r\n-      console.log('Promo code not found:', promoCode); // Debug log\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Mã giảm giá không tồn tại' },\r\n         { status: 404 }\r\n       );\r\n     }\r\n \r\n     if (!promo.isActive) {\r\n-      console.log('Promo code is inactive'); // Debug log\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Mã giảm giá đã bị vô hiệu hóa' },\r\n         { status: 400 }\r\n       );\r\n     }\r\n \r\n     // Kiểm tra ngày hết hạn\r\n-    if (promo.expiryDate) {\r\n-      const expiryDate = new Date(promo.expiryDate);\r\n-      const now = new Date();\r\n-      console.log('Checking expiry date:', { expiryDate, now }); // Debug log\r\n-      \r\n-      if (now > expiryDate) {\r\n-        console.log('Promo code has expired'); // Debug log\r\n-        return NextResponse.json(\r\n-          { ok: false, message: 'Mã giảm giá đã hết hạn' },\r\n-          { status: 400 }\r\n-        );\r\n-      }\r\n+    if (promo.expiryDate && new Date() > new Date(promo.expiryDate)) {\r\n+      return NextResponse.json(\r\n+        { ok: false, message: 'Mã giảm giá đã hết hạn' },\r\n+        { status: 400 }\r\n+      );\r\n     }\r\n \r\n     // Kiểm tra yêu cầu đăng nhập\r\n     if (promo.isLoginRequired && !session?.user?.email) {\r\n-      console.log('Login required but no session'); // Debug log\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Vui lòng đăng nhập để sử dụng mã giảm giá này' },\r\n         { status: 401 }\r\n       );\r\n@@ -71,10 +58,8 @@\n       const userUsageCount = promo.usedByUsers?.filter(\r\n         (user: { email: string; count: number }) => user.email === userEmail\r\n       ).reduce((total: number, user: { count: number }) => total + user.count, 0) || 0;\r\n \r\n-      console.log('Checking user limit:', { userEmail, userUsageCount, perUserLimit: promo.perUserLimit }); // Debug log\r\n-\r\n       if (userUsageCount >= promo.perUserLimit) {\r\n         return NextResponse.json(\r\n           { ok: false, message: 'Bạn đã sử dụng hết số lần cho phép của mã giảm giá này' },\r\n           { status: 400 }\r\n@@ -87,35 +72,71 @@\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n-      const isApplicable = promo.scope === 'all' || (promo.scope === 'selected' && promo.selectedProducts?.includes(item.id));\r\n+      const isApplicable = promo.scope === 'all' || \r\n+        (promo.scope === 'selected' && \r\n+          (promo.selectedProducts?.includes(item.id) || \r\n+           promo.selectedProducts?.includes(item.productId)));\r\n+\r\n       console.log('Checking item applicability:', { \r\n-        itemId: item.id, \r\n+        itemId: item.id,\r\n+        productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n-        isApplicable \r\n+        isApplicable,\r\n+        itemPrice: item.price,\r\n+        itemQuantity: item.quantity,\r\n+        promoType: promo.type,\r\n+        promoValue: promo.value,\r\n+        promoMaxAmount: promo.maxAmount\r\n       }); // Debug log\r\n \r\n       if (isApplicable) {\r\n         if (promo.type === 'fixed') {\r\n           itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n+          console.log('Fixed discount calculation:', {\r\n+            promoValue: promo.value,\r\n+            itemTotal: item.price * item.quantity,\r\n+            calculatedDiscount: itemDiscount\r\n+          });\r\n         } else {\r\n           const percentageDiscount = (item.price * item.quantity * promo.value) / 100;\r\n           itemDiscount = promo.maxAmount \r\n             ? Math.min(percentageDiscount, promo.maxAmount)\r\n             : percentageDiscount;\r\n+          console.log('Percentage discount calculation:', {\r\n+            itemTotal: item.price * item.quantity,\r\n+            percentage: promo.value,\r\n+            calculatedPercentage: percentageDiscount,\r\n+            maxAmount: promo.maxAmount,\r\n+            finalDiscount: itemDiscount\r\n+          });\r\n         }\r\n       }\r\n \r\n       totalDiscount += itemDiscount;\r\n       return {\r\n         ...item,\r\n-        discount: itemDiscount\r\n+        discount: itemDiscount,\r\n+        isPromoApplied: isApplicable,\r\n+        originalPrice: item.price * item.quantity,\r\n+        finalPrice: (item.price * item.quantity) - itemDiscount\r\n       };\r\n     });\r\n \r\n-    console.log('Applied discounts:', { updatedCartItems, totalDiscount }); // Debug log\r\n+    console.log('Applied discounts:', { \r\n+      updatedCartItems, \r\n+      totalDiscount,\r\n+      promoDetails: {\r\n+        code: promo.code,\r\n+        type: promo.type,\r\n+        value: promo.value,\r\n+        maxAmount: promo.maxAmount,\r\n+        scope: promo.scope,\r\n+        selectedProducts: promo.selectedProducts\r\n+      }\r\n+    }); // Debug log\r\n \r\n     return NextResponse.json({\r\n       ok: true,\r\n       message: 'Áp dụng mã giảm giá thành công',\r\n"
                },
                {
                    "date": 1749541054833,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -82,62 +82,30 @@\n         itemId: item.id,\r\n         productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n-        isApplicable,\r\n-        itemPrice: item.price,\r\n-        itemQuantity: item.quantity,\r\n-        promoType: promo.type,\r\n-        promoValue: promo.value,\r\n-        promoMaxAmount: promo.maxAmount\r\n+        isApplicable \r\n       }); // Debug log\r\n \r\n       if (isApplicable) {\r\n         if (promo.type === 'fixed') {\r\n           itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n-          console.log('Fixed discount calculation:', {\r\n-            promoValue: promo.value,\r\n-            itemTotal: item.price * item.quantity,\r\n-            calculatedDiscount: itemDiscount\r\n-          });\r\n         } else {\r\n           const percentageDiscount = (item.price * item.quantity * promo.value) / 100;\r\n           itemDiscount = promo.maxAmount \r\n             ? Math.min(percentageDiscount, promo.maxAmount)\r\n             : percentageDiscount;\r\n-          console.log('Percentage discount calculation:', {\r\n-            itemTotal: item.price * item.quantity,\r\n-            percentage: promo.value,\r\n-            calculatedPercentage: percentageDiscount,\r\n-            maxAmount: promo.maxAmount,\r\n-            finalDiscount: itemDiscount\r\n-          });\r\n         }\r\n       }\r\n \r\n       totalDiscount += itemDiscount;\r\n       return {\r\n         ...item,\r\n         discount: itemDiscount,\r\n-        isPromoApplied: isApplicable,\r\n-        originalPrice: item.price * item.quantity,\r\n-        finalPrice: (item.price * item.quantity) - itemDiscount\r\n+        isPromoApplied: isApplicable // Thêm flag để biết sản phẩm có được áp dụng mã giảm giá không\r\n       };\r\n     });\r\n \r\n-    console.log('Applied discounts:', { \r\n-      updatedCartItems, \r\n-      totalDiscount,\r\n-      promoDetails: {\r\n-        code: promo.code,\r\n-        type: promo.type,\r\n-        value: promo.value,\r\n-        maxAmount: promo.maxAmount,\r\n-        scope: promo.scope,\r\n-        selectedProducts: promo.selectedProducts\r\n-      }\r\n-    }); // Debug log\r\n-\r\n     return NextResponse.json({\r\n       ok: true,\r\n       message: 'Áp dụng mã giảm giá thành công',\r\n       cartItems: updatedCartItems,\r\n"
                },
                {
                    "date": 1749541073686,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -72,22 +72,9 @@\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n-      const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && \r\n-          (promo.selectedProducts?.includes(item.id) || \r\n-           promo.selectedProducts?.includes(item.productId)));\r\n-\r\n-      console.log('Checking item applicability:', { \r\n-        itemId: item.id,\r\n-        productId: item.productId,\r\n-        scope: promo.scope, \r\n-        selectedProducts: promo.selectedProducts,\r\n-        isApplicable \r\n-      }); // Debug log\r\n-\r\n-      if (isApplicable) {\r\n+      if (promo.scope === 'all' || (promo.scope === 'selected' && promo.selectedProducts?.includes(item.id))) {\r\n         if (promo.type === 'fixed') {\r\n           itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n         } else {\r\n           const percentageDiscount = (item.price * item.quantity * promo.value) / 100;\r\n@@ -99,10 +86,9 @@\n \r\n       totalDiscount += itemDiscount;\r\n       return {\r\n         ...item,\r\n-        discount: itemDiscount,\r\n-        isPromoApplied: isApplicable // Thêm flag để biết sản phẩm có được áp dụng mã giảm giá không\r\n+        discount: itemDiscount\r\n       };\r\n     });\r\n \r\n     return NextResponse.json({\r\n"
                },
                {
                    "date": 1749541296579,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -72,9 +72,22 @@\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n-      if (promo.scope === 'all' || (promo.scope === 'selected' && promo.selectedProducts?.includes(item.id))) {\r\n+      const isApplicable = promo.scope === 'all' || \r\n+        (promo.scope === 'selected' && \r\n+          (promo.selectedProducts?.includes(item.id) || \r\n+           promo.selectedProducts?.includes(item.productId)));\r\n+\r\n+      console.log('Checking item applicability:', { \r\n+        itemId: item.id,\r\n+        productId: item.productId,\r\n+        scope: promo.scope, \r\n+        selectedProducts: promo.selectedProducts,\r\n+        isApplicable \r\n+      }); // Debug log\r\n+\r\n+      if (isApplicable) {\r\n         if (promo.type === 'fixed') {\r\n           itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n         } else {\r\n           const percentageDiscount = (item.price * item.quantity * promo.value) / 100;\r\n@@ -86,9 +99,10 @@\n \r\n       totalDiscount += itemDiscount;\r\n       return {\r\n         ...item,\r\n-        discount: itemDiscount\r\n+        discount: itemDiscount,\r\n+        isPromoApplied: isApplicable // Thêm flag để biết sản phẩm có được áp dụng mã giảm giá không\r\n       };\r\n     });\r\n \r\n     return NextResponse.json({\r\n"
                },
                {
                    "date": 1749541486303,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -68,24 +68,45 @@\n     }\r\n \r\n     // Tính toán giảm giá cho từng sản phẩm\r\n     let totalDiscount = 0;\r\n+    console.log('Promo details:', {\r\n+      code: promo.code,\r\n+      scope: promo.scope,\r\n+      selectedProducts: promo.selectedProducts,\r\n+      type: promo.type,\r\n+      value: promo.value\r\n+    });\r\n+\r\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n+      // Log chi tiết về item\r\n+      console.log('Processing item:', {\r\n+        itemId: item.id,\r\n+        productId: item.productId,\r\n+        name: item.name,\r\n+        price: item.price,\r\n+        quantity: item.quantity\r\n+      });\r\n+\r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       const isApplicable = promo.scope === 'all' || \r\n         (promo.scope === 'selected' && \r\n-          (promo.selectedProducts?.includes(item.id) || \r\n-           promo.selectedProducts?.includes(item.productId)));\r\n+          (promo.selectedProducts?.includes(item.productId) || \r\n+           (item.id && promo.selectedProducts?.includes(item.id))));\r\n \r\n-      console.log('Checking item applicability:', { \r\n+      console.log('Item applicability check:', { \r\n         itemId: item.id,\r\n         productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n-        isApplicable \r\n-      }); // Debug log\r\n+        isApplicable,\r\n+        matches: {\r\n+          byProductId: promo.selectedProducts?.includes(item.productId),\r\n+          byItemId: item.id && promo.selectedProducts?.includes(item.id)\r\n+        }\r\n+      });\r\n \r\n       if (isApplicable) {\r\n         if (promo.type === 'fixed') {\r\n           itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n@@ -100,12 +121,23 @@\n       totalDiscount += itemDiscount;\r\n       return {\r\n         ...item,\r\n         discount: itemDiscount,\r\n-        isPromoApplied: isApplicable // Thêm flag để biết sản phẩm có được áp dụng mã giảm giá không\r\n+        isPromoApplied: isApplicable\r\n       };\r\n     });\r\n \r\n+    console.log('Final results:', {\r\n+      totalDiscount,\r\n+      updatedItems: updatedCartItems.map(item => ({\r\n+        id: item.id,\r\n+        productId: item.productId,\r\n+        name: item.name,\r\n+        isPromoApplied: item.isPromoApplied,\r\n+        discount: item.discount\r\n+      }))\r\n+    });\r\n+\r\n     return NextResponse.json({\r\n       ok: true,\r\n       message: 'Áp dụng mã giảm giá thành công',\r\n       cartItems: updatedCartItems,\r\n"
                },
                {
                    "date": 1749541501858,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -90,21 +90,18 @@\n       });\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && \r\n-          (promo.selectedProducts?.includes(item.productId) || \r\n-           (item.id && promo.selectedProducts?.includes(item.id))));\r\n+        (promo.scope === 'selected' && promo.selectedProducts?.includes(item.productId));\r\n \r\n       console.log('Item applicability check:', { \r\n         itemId: item.id,\r\n         productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n         isApplicable,\r\n         matches: {\r\n-          byProductId: promo.selectedProducts?.includes(item.productId),\r\n-          byItemId: item.id && promo.selectedProducts?.includes(item.id)\r\n+          byProductId: promo.selectedProducts?.includes(item.productId)\r\n         }\r\n       });\r\n \r\n       if (isApplicable) {\r\n"
                },
                {
                    "date": 1749541549147,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -89,22 +89,29 @@\n         quantity: item.quantity\r\n       });\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n-      const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && promo.selectedProducts?.includes(item.productId));\r\n+      let isApplicable = false;\r\n+      \r\n+      if (promo.scope === 'all') {\r\n+        isApplicable = true;\r\n+      } else if (promo.scope === 'selected') {\r\n+        // Kiểm tra cả productId và id\r\n+        const productIdMatch = item.productId && promo.selectedProducts?.includes(item.productId);\r\n+        const itemIdMatch = item.id && promo.selectedProducts?.includes(item.id);\r\n+        \r\n+        isApplicable = productIdMatch || itemIdMatch;\r\n+        \r\n+        console.log('Selected product check:', {\r\n+          productId: item.productId,\r\n+          itemId: item.id,\r\n+          selectedProducts: promo.selectedProducts,\r\n+          productIdMatch,\r\n+          itemIdMatch,\r\n+          isApplicable\r\n+        });\r\n+      }\r\n \r\n-      console.log('Item applicability check:', { \r\n-        itemId: item.id,\r\n-        productId: item.productId,\r\n-        scope: promo.scope, \r\n-        selectedProducts: promo.selectedProducts,\r\n-        isApplicable,\r\n-        matches: {\r\n-          byProductId: promo.selectedProducts?.includes(item.productId)\r\n-        }\r\n-      });\r\n-\r\n       if (isApplicable) {\r\n         if (promo.type === 'fixed') {\r\n           itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n         } else {\r\n"
                },
                {
                    "date": 1749541565128,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -68,50 +68,25 @@\n     }\r\n \r\n     // Tính toán giảm giá cho từng sản phẩm\r\n     let totalDiscount = 0;\r\n-    console.log('Promo details:', {\r\n-      code: promo.code,\r\n-      scope: promo.scope,\r\n-      selectedProducts: promo.selectedProducts,\r\n-      type: promo.type,\r\n-      value: promo.value\r\n-    });\r\n-\r\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n-      // Log chi tiết về item\r\n-      console.log('Processing item:', {\r\n+      // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n+      const isApplicable = promo.scope === 'all' || \r\n+        (promo.scope === 'selected' && \r\n+          (promo.selectedProducts?.includes(item.id) || \r\n+           promo.selectedProducts?.includes(item.productId)));\r\n+\r\n+      console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n         productId: item.productId,\r\n-        name: item.name,\r\n-        price: item.price,\r\n-        quantity: item.quantity\r\n-      });\r\n+        scope: promo.scope, \r\n+        selectedProducts: promo.selectedProducts,\r\n+        isApplicable \r\n+      }); // Debug log\r\n \r\n-      // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n-      let isApplicable = false;\r\n-      \r\n-      if (promo.scope === 'all') {\r\n-        isApplicable = true;\r\n-      } else if (promo.scope === 'selected') {\r\n-        // Kiểm tra cả productId và id\r\n-        const productIdMatch = item.productId && promo.selectedProducts?.includes(item.productId);\r\n-        const itemIdMatch = item.id && promo.selectedProducts?.includes(item.id);\r\n-        \r\n-        isApplicable = productIdMatch || itemIdMatch;\r\n-        \r\n-        console.log('Selected product check:', {\r\n-          productId: item.productId,\r\n-          itemId: item.id,\r\n-          selectedProducts: promo.selectedProducts,\r\n-          productIdMatch,\r\n-          itemIdMatch,\r\n-          isApplicable\r\n-        });\r\n-      }\r\n-\r\n       if (isApplicable) {\r\n         if (promo.type === 'fixed') {\r\n           itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n         } else {\r\n@@ -125,23 +100,12 @@\n       totalDiscount += itemDiscount;\r\n       return {\r\n         ...item,\r\n         discount: itemDiscount,\r\n-        isPromoApplied: isApplicable\r\n+        isPromoApplied: isApplicable // Thêm flag để biết sản phẩm có được áp dụng mã giảm giá không\r\n       };\r\n     });\r\n \r\n-    console.log('Final results:', {\r\n-      totalDiscount,\r\n-      updatedItems: updatedCartItems.map(item => ({\r\n-        id: item.id,\r\n-        productId: item.productId,\r\n-        name: item.name,\r\n-        isPromoApplied: item.isPromoApplied,\r\n-        discount: item.discount\r\n-      }))\r\n-    });\r\n-\r\n     return NextResponse.json({\r\n       ok: true,\r\n       message: 'Áp dụng mã giảm giá thành công',\r\n       cartItems: updatedCartItems,\r\n"
                },
                {
                    "date": 1749541621849,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,11 +73,9 @@\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && \r\n-          (promo.selectedProducts?.includes(item.id) || \r\n-           promo.selectedProducts?.includes(item.productId)));\r\n+        (promo.scope === 'selected' && promo.selectedProducts?.includes(item.productId));\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n         productId: item.productId,\r\n"
                },
                {
                    "date": 1749541839892,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,9 +73,9 @@\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && promo.selectedProducts?.includes(item.productId));\r\n+        (promo.scope === 'selected' && item.productId && promo.selectedProducts?.includes(item.productId));\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n         productId: item.productId,\r\n"
                },
                {
                    "date": 1749542067572,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,13 +73,12 @@\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && item.productId && promo.selectedProducts?.includes(item.productId));\r\n+        (promo.scope === 'selected' && item.id && promo.selectedProducts?.includes(item.id));\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n-        productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n         isApplicable \r\n       }); // Debug log\r\n"
                },
                {
                    "date": 1749542378485,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,12 +73,15 @@\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && item.id && promo.selectedProducts?.includes(item.id));\r\n+        (promo.scope === 'selected' && \r\n+          (item.id && promo.selectedProducts?.includes(item.id)) || \r\n+          (item.productId && promo.selectedProducts?.includes(item.productId)));\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n+        productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n         isApplicable \r\n       }); // Debug log\r\n"
                },
                {
                    "date": 1749542652373,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,15 +73,12 @@\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && \r\n-          (item.id && promo.selectedProducts?.includes(item.id)) || \r\n-          (item.productId && promo.selectedProducts?.includes(item.productId)));\r\n+        (promo.scope === 'selected' && item.id && promo.selectedProducts?.includes(item.id));\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n-        productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n         isApplicable \r\n       }); // Debug log\r\n"
                },
                {
                    "date": 1749542943444,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,15 +73,22 @@\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && item.id && promo.selectedProducts?.includes(item.id));\r\n+        (promo.scope === 'selected' && \r\n+          (promo.selectedProducts?.includes(item.id) || \r\n+           (item.productId && promo.selectedProducts?.includes(item.productId))));\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n+        productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n-        isApplicable \r\n+        isApplicable,\r\n+        matches: {\r\n+          byId: promo.selectedProducts?.includes(item.id),\r\n+          byProductId: item.productId && promo.selectedProducts?.includes(item.productId)\r\n+        }\r\n       }); // Debug log\r\n \r\n       if (isApplicable) {\r\n         if (promo.type === 'fixed') {\r\n"
                },
                {
                    "date": 1749543213120,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,21 +73,17 @@\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && \r\n-          (promo.selectedProducts?.includes(item.id) || \r\n-           (item.productId && promo.selectedProducts?.includes(item.productId))));\r\n+        (promo.scope === 'selected' && item.id && promo.selectedProducts?.includes(item.id));\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n-        productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n         isApplicable,\r\n         matches: {\r\n-          byId: promo.selectedProducts?.includes(item.id),\r\n-          byProductId: item.productId && promo.selectedProducts?.includes(item.productId)\r\n+          byId: promo.selectedProducts?.includes(item.id)\r\n         }\r\n       }); // Debug log\r\n \r\n       if (isApplicable) {\r\n"
                },
                {
                    "date": 1749543301504,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,8 +11,10 @@\n     const session = await getServerSession(authOptions);\r\n     const { db } = await connectToDatabase();\r\n     const { promoCode, cartItems } = await request.json();\r\n \r\n+    console.log('Received request:', { promoCode, cartItems }); // Log request data\r\n+\r\n     if (!promoCode || !cartItems || !Array.isArray(cartItems)) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Invalid request data' },\r\n         { status: 400 }\r\n@@ -20,8 +22,9 @@\n     }\r\n \r\n     // Tìm mã giảm giá\r\n     const promo = await db.collection('promoCodes').findOne({ code: promoCode });\r\n+    console.log('Found promo code:', promo); // Log found promo code\r\n \r\n     if (!promo) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Mã giảm giá không tồn tại' },\r\n@@ -68,8 +71,14 @@\n     }\r\n \r\n     // Tính toán giảm giá cho từng sản phẩm\r\n     let totalDiscount = 0;\r\n+    console.log('Processing cart items with promo:', {\r\n+      promoScope: promo.scope,\r\n+      selectedProducts: promo.selectedProducts,\r\n+      cartItemsCount: cartItems.length\r\n+    }); // Log before processing items\r\n+\r\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n@@ -77,8 +86,9 @@\n         (promo.scope === 'selected' && item.id && promo.selectedProducts?.includes(item.id));\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n+        itemName: item.name,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n         isApplicable,\r\n         matches: {\r\n@@ -94,18 +104,33 @@\n           itemDiscount = promo.maxAmount \r\n             ? Math.min(percentageDiscount, promo.maxAmount)\r\n             : percentageDiscount;\r\n         }\r\n+        console.log('Applied discount to item:', {\r\n+          itemName: item.name,\r\n+          originalPrice: item.price * item.quantity,\r\n+          discount: itemDiscount,\r\n+          finalPrice: (item.price * item.quantity) - itemDiscount\r\n+        }); // Log discount calculation\r\n       }\r\n \r\n       totalDiscount += itemDiscount;\r\n       return {\r\n         ...item,\r\n         discount: itemDiscount,\r\n-        isPromoApplied: isApplicable // Thêm flag để biết sản phẩm có được áp dụng mã giảm giá không\r\n+        isPromoApplied: isApplicable\r\n       };\r\n     });\r\n \r\n+    console.log('Final results:', {\r\n+      totalDiscount,\r\n+      updatedItems: updatedCartItems.map(item => ({\r\n+        name: item.name,\r\n+        isPromoApplied: item.isPromoApplied,\r\n+        discount: item.discount\r\n+      }))\r\n+    }); // Log final results\r\n+\r\n     return NextResponse.json({\r\n       ok: true,\r\n       message: 'Áp dụng mã giảm giá thành công',\r\n       cartItems: updatedCartItems,\r\n"
                },
                {
                    "date": 1749543316067,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,10 +11,8 @@\n     const session = await getServerSession(authOptions);\r\n     const { db } = await connectToDatabase();\r\n     const { promoCode, cartItems } = await request.json();\r\n \r\n-    console.log('Received request:', { promoCode, cartItems }); // Log request data\r\n-\r\n     if (!promoCode || !cartItems || !Array.isArray(cartItems)) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Invalid request data' },\r\n         { status: 400 }\r\n@@ -22,9 +20,8 @@\n     }\r\n \r\n     // Tìm mã giảm giá\r\n     const promo = await db.collection('promoCodes').findOne({ code: promoCode });\r\n-    console.log('Found promo code:', promo); // Log found promo code\r\n \r\n     if (!promo) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Mã giảm giá không tồn tại' },\r\n@@ -71,14 +68,8 @@\n     }\r\n \r\n     // Tính toán giảm giá cho từng sản phẩm\r\n     let totalDiscount = 0;\r\n-    console.log('Processing cart items with promo:', {\r\n-      promoScope: promo.scope,\r\n-      selectedProducts: promo.selectedProducts,\r\n-      cartItemsCount: cartItems.length\r\n-    }); // Log before processing items\r\n-\r\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n@@ -86,9 +77,8 @@\n         (promo.scope === 'selected' && item.id && promo.selectedProducts?.includes(item.id));\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n-        itemName: item.name,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n         isApplicable,\r\n         matches: {\r\n@@ -104,33 +94,18 @@\n           itemDiscount = promo.maxAmount \r\n             ? Math.min(percentageDiscount, promo.maxAmount)\r\n             : percentageDiscount;\r\n         }\r\n-        console.log('Applied discount to item:', {\r\n-          itemName: item.name,\r\n-          originalPrice: item.price * item.quantity,\r\n-          discount: itemDiscount,\r\n-          finalPrice: (item.price * item.quantity) - itemDiscount\r\n-        }); // Log discount calculation\r\n       }\r\n \r\n       totalDiscount += itemDiscount;\r\n       return {\r\n         ...item,\r\n         discount: itemDiscount,\r\n-        isPromoApplied: isApplicable\r\n+        isPromoApplied: isApplicable // Thêm flag để biết sản phẩm có được áp dụng mã giảm giá không\r\n       };\r\n     });\r\n \r\n-    console.log('Final results:', {\r\n-      totalDiscount,\r\n-      updatedItems: updatedCartItems.map(item => ({\r\n-        name: item.name,\r\n-        isPromoApplied: item.isPromoApplied,\r\n-        discount: item.discount\r\n-      }))\r\n-    }); // Log final results\r\n-\r\n     return NextResponse.json({\r\n       ok: true,\r\n       message: 'Áp dụng mã giảm giá thành công',\r\n       cartItems: updatedCartItems,\r\n"
                },
                {
                    "date": 1749543504290,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,17 +73,21 @@\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && item.id && promo.selectedProducts?.includes(item.id));\r\n+        (promo.scope === 'selected' && \r\n+          (item.id && promo.selectedProducts?.includes(item.id)) || \r\n+          (item.productId && promo.selectedProducts?.includes(item.productId)));\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n+        productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n         isApplicable,\r\n         matches: {\r\n-          byId: promo.selectedProducts?.includes(item.id)\r\n+          byId: item.id && promo.selectedProducts?.includes(item.id),\r\n+          byProductId: item.productId && promo.selectedProducts?.includes(item.productId)\r\n         }\r\n       }); // Debug log\r\n \r\n       if (isApplicable) {\r\n"
                },
                {
                    "date": 1749543553864,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,21 +73,17 @@\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && \r\n-          (item.id && promo.selectedProducts?.includes(item.id)) || \r\n-          (item.productId && promo.selectedProducts?.includes(item.productId)));\r\n+        (promo.scope === 'selected' && item.id && promo.selectedProducts?.includes(item.id));\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n-        productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n         isApplicable,\r\n         matches: {\r\n-          byId: item.id && promo.selectedProducts?.includes(item.id),\r\n-          byProductId: item.productId && promo.selectedProducts?.includes(item.productId)\r\n+          byId: promo.selectedProducts?.includes(item.id)\r\n         }\r\n       }); // Debug log\r\n \r\n       if (isApplicable) {\r\n"
                },
                {
                    "date": 1749543576187,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,8 +11,10 @@\n     const session = await getServerSession(authOptions);\r\n     const { db } = await connectToDatabase();\r\n     const { promoCode, cartItems } = await request.json();\r\n \r\n+    console.log('Received request data:', { promoCode, cartItems }); // Debug log\r\n+\r\n     if (!promoCode || !cartItems || !Array.isArray(cartItems)) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Invalid request data' },\r\n         { status: 400 }\r\n@@ -20,8 +22,9 @@\n     }\r\n \r\n     // Tìm mã giảm giá\r\n     const promo = await db.collection('promoCodes').findOne({ code: promoCode });\r\n+    console.log('Found promo code:', promo); // Debug log\r\n \r\n     if (!promo) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Mã giảm giá không tồn tại' },\r\n@@ -68,8 +71,13 @@\n     }\r\n \r\n     // Tính toán giảm giá cho từng sản phẩm\r\n     let totalDiscount = 0;\r\n+    console.log('Processing cart items with promo:', { \r\n+      scope: promo.scope, \r\n+      selectedProducts: promo.selectedProducts \r\n+    }); // Debug log\r\n+\r\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n@@ -104,8 +112,10 @@\n         isPromoApplied: isApplicable // Thêm flag để biết sản phẩm có được áp dụng mã giảm giá không\r\n       };\r\n     });\r\n \r\n+    console.log('Applied discounts:', { updatedCartItems, totalDiscount }); // Debug log\r\n+\r\n     return NextResponse.json({\r\n       ok: true,\r\n       message: 'Áp dụng mã giảm giá thành công',\r\n       cartItems: updatedCartItems,\r\n"
                },
                {
                    "date": 1749543645061,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,10 +11,8 @@\n     const session = await getServerSession(authOptions);\r\n     const { db } = await connectToDatabase();\r\n     const { promoCode, cartItems } = await request.json();\r\n \r\n-    console.log('Received request data:', { promoCode, cartItems }); // Debug log\r\n-\r\n     if (!promoCode || !cartItems || !Array.isArray(cartItems)) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Invalid request data' },\r\n         { status: 400 }\r\n@@ -22,9 +20,8 @@\n     }\r\n \r\n     // Tìm mã giảm giá\r\n     const promo = await db.collection('promoCodes').findOne({ code: promoCode });\r\n-    console.log('Found promo code:', promo); // Debug log\r\n \r\n     if (!promo) {\r\n       return NextResponse.json(\r\n         { ok: false, message: 'Mã giảm giá không tồn tại' },\r\n@@ -71,13 +68,8 @@\n     }\r\n \r\n     // Tính toán giảm giá cho từng sản phẩm\r\n     let totalDiscount = 0;\r\n-    console.log('Processing cart items with promo:', { \r\n-      scope: promo.scope, \r\n-      selectedProducts: promo.selectedProducts \r\n-    }); // Debug log\r\n-\r\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n@@ -112,10 +104,8 @@\n         isPromoApplied: isApplicable // Thêm flag để biết sản phẩm có được áp dụng mã giảm giá không\r\n       };\r\n     });\r\n \r\n-    console.log('Applied discounts:', { updatedCartItems, totalDiscount }); // Debug log\r\n-\r\n     return NextResponse.json({\r\n       ok: true,\r\n       message: 'Áp dụng mã giảm giá thành công',\r\n       cartItems: updatedCartItems,\r\n"
                },
                {
                    "date": 1749543691586,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -71,38 +71,23 @@\n     let totalDiscount = 0;\r\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n-      // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n-      const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && item.id && promo.selectedProducts?.includes(item.id));\r\n-\r\n-      console.log('Checking item applicability:', { \r\n-        itemId: item.id,\r\n-        scope: promo.scope, \r\n-        selectedProducts: promo.selectedProducts,\r\n-        isApplicable,\r\n-        matches: {\r\n-          byId: promo.selectedProducts?.includes(item.id)\r\n-        }\r\n-      }); // Debug log\r\n-\r\n-      if (isApplicable) {\r\n-        if (promo.type === 'fixed') {\r\n-          itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n-        } else {\r\n-          const percentageDiscount = (item.price * item.quantity * promo.value) / 100;\r\n-          itemDiscount = promo.maxAmount \r\n-            ? Math.min(percentageDiscount, promo.maxAmount)\r\n-            : percentageDiscount;\r\n-        }\r\n+      // Áp dụng mã giảm giá cho tất cả sản phẩm\r\n+      if (promo.type === 'fixed') {\r\n+        itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n+      } else {\r\n+        const percentageDiscount = (item.price * item.quantity * promo.value) / 100;\r\n+        itemDiscount = promo.maxAmount \r\n+          ? Math.min(percentageDiscount, promo.maxAmount)\r\n+          : percentageDiscount;\r\n       }\r\n \r\n       totalDiscount += itemDiscount;\r\n       return {\r\n         ...item,\r\n         discount: itemDiscount,\r\n-        isPromoApplied: isApplicable // Thêm flag để biết sản phẩm có được áp dụng mã giảm giá không\r\n+        isPromoApplied: true\r\n       };\r\n     });\r\n \r\n     return NextResponse.json({\r\n"
                },
                {
                    "date": 1749544878170,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -71,23 +71,38 @@\n     let totalDiscount = 0;\r\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n-      // Áp dụng mã giảm giá cho tất cả sản phẩm\r\n-      if (promo.type === 'fixed') {\r\n-        itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n-      } else {\r\n-        const percentageDiscount = (item.price * item.quantity * promo.value) / 100;\r\n-        itemDiscount = promo.maxAmount \r\n-          ? Math.min(percentageDiscount, promo.maxAmount)\r\n-          : percentageDiscount;\r\n+      // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n+      const isApplicable = promo.scope === 'all' || \r\n+        (promo.scope === 'selected' && item.id && promo.selectedProducts?.includes(item.id));\r\n+\r\n+      console.log('Checking item applicability:', { \r\n+        itemId: item.id,\r\n+        scope: promo.scope, \r\n+        selectedProducts: promo.selectedProducts,\r\n+        isApplicable,\r\n+        matches: {\r\n+          byId: promo.selectedProducts?.includes(item.id)\r\n+        }\r\n+      }); // Debug log\r\n+\r\n+      if (isApplicable) {\r\n+        if (promo.type === 'fixed') {\r\n+          itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n+        } else {\r\n+          const percentageDiscount = (item.price * item.quantity * promo.value) / 100;\r\n+          itemDiscount = promo.maxAmount \r\n+            ? Math.min(percentageDiscount, promo.maxAmount)\r\n+            : percentageDiscount;\r\n+        }\r\n       }\r\n \r\n       totalDiscount += itemDiscount;\r\n       return {\r\n         ...item,\r\n         discount: itemDiscount,\r\n-        isPromoApplied: true\r\n+        isPromoApplied: isApplicable // Thêm flag để biết sản phẩm có được áp dụng mã giảm giá không\r\n       };\r\n     });\r\n \r\n     return NextResponse.json({\r\n"
                },
                {
                    "date": 1749545974971,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,17 +73,21 @@\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && item.id && promo.selectedProducts?.includes(item.id));\r\n+        (promo.scope === 'selected' && \r\n+          (item.id && promo.selectedProducts?.includes(item.id)) || \r\n+          (item.productId && promo.selectedProducts?.includes(item.productId)));\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n+        productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n         isApplicable,\r\n         matches: {\r\n-          byId: promo.selectedProducts?.includes(item.id)\r\n+          byId: item.id && promo.selectedProducts?.includes(item.id),\r\n+          byProductId: item.productId && promo.selectedProducts?.includes(item.productId)\r\n         }\r\n       }); // Debug log\r\n \r\n       if (isApplicable) {\r\n"
                },
                {
                    "date": 1749546069971,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -74,10 +74,10 @@\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       const isApplicable = promo.scope === 'all' || \r\n         (promo.scope === 'selected' && \r\n-          (item.id && promo.selectedProducts?.includes(item.id)) || \r\n-          (item.productId && promo.selectedProducts?.includes(item.productId)));\r\n+          ((item.id && promo.selectedProducts?.includes(item.id)) || \r\n+           (item.productId && promo.selectedProducts?.includes(item.productId))));\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n         productId: item.productId,\r\n"
                },
                {
                    "date": 1749546356547,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -72,23 +72,25 @@\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n-      const isApplicable = promo.scope === 'all' || \r\n-        (promo.scope === 'selected' && \r\n-          ((item.id && promo.selectedProducts?.includes(item.id)) || \r\n-           (item.productId && promo.selectedProducts?.includes(item.productId))));\r\n+      let isApplicable = false;\r\n+      \r\n+      if (promo.scope === 'all') {\r\n+        isApplicable = true;\r\n+      } else if (promo.scope === 'selected' && promo.selectedProducts && promo.selectedProducts.length > 0) {\r\n+        // Kiểm tra cả id và productId\r\n+        const itemId = item.id || item.productId;\r\n+        isApplicable = itemId ? promo.selectedProducts.includes(itemId) : false;\r\n+      }\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n         productId: item.productId,\r\n         scope: promo.scope, \r\n         selectedProducts: promo.selectedProducts,\r\n         isApplicable,\r\n-        matches: {\r\n-          byId: item.id && promo.selectedProducts?.includes(item.id),\r\n-          byProductId: item.productId && promo.selectedProducts?.includes(item.productId)\r\n-        }\r\n+        itemIdUsed: item.id || item.productId\r\n       }); // Debug log\r\n \r\n       if (isApplicable) {\r\n         if (promo.type === 'fixed') {\r\n"
                },
                {
                    "date": 1749546668251,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,25 +73,49 @@\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       let isApplicable = false;\r\n-      \r\n-      if (promo.scope === 'all') {\r\n+\r\n+      // Log thông tin để debug\r\n+      console.log('Promo details:', {\r\n+        code: promo.code,\r\n+        scope: promo.scope,\r\n+        selectedProducts: promo.selectedProducts\r\n+      });\r\n+\r\n+      console.log('Item details:', {\r\n+        id: item.id,\r\n+        productId: item.productId,\r\n+        name: item.name\r\n+      });\r\n+\r\n+      // Kiểm tra phạm vi áp dụng\r\n+      if (promo.scope === 'selected') {\r\n+        // Nếu là phạm vi selected, kiểm tra ID sản phẩm\r\n+        const productId = item.productId || item.id;\r\n+        \r\n+        if (!productId) {\r\n+          console.log('No product ID found for item');\r\n+          isApplicable = false;\r\n+        } else if (!promo.selectedProducts || !Array.isArray(promo.selectedProducts)) {\r\n+          console.log('No selected products array in promo');\r\n+          isApplicable = false;\r\n+        } else {\r\n+          isApplicable = promo.selectedProducts.includes(productId);\r\n+          console.log('Product ID check:', {\r\n+            productId,\r\n+            isInSelectedProducts: isApplicable\r\n+          });\r\n+        }\r\n+      } else if (promo.scope === 'all') {\r\n         isApplicable = true;\r\n-      } else if (promo.scope === 'selected' && promo.selectedProducts && promo.selectedProducts.length > 0) {\r\n-        // Kiểm tra cả id và productId\r\n-        const itemId = item.id || item.productId;\r\n-        isApplicable = itemId ? promo.selectedProducts.includes(itemId) : false;\r\n+        console.log('Applying to all products');\r\n       }\r\n \r\n-      console.log('Checking item applicability:', { \r\n-        itemId: item.id,\r\n-        productId: item.productId,\r\n-        scope: promo.scope, \r\n-        selectedProducts: promo.selectedProducts,\r\n-        isApplicable,\r\n-        itemIdUsed: item.id || item.productId\r\n-      }); // Debug log\r\n+      console.log('Final applicability:', {\r\n+        itemName: item.name,\r\n+        isApplicable\r\n+      });\r\n \r\n       if (isApplicable) {\r\n         if (promo.type === 'fixed') {\r\n           itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n"
                },
                {
                    "date": 1749546717315,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,49 +73,25 @@\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       let isApplicable = false;\r\n-\r\n-      // Log thông tin để debug\r\n-      console.log('Promo details:', {\r\n-        code: promo.code,\r\n-        scope: promo.scope,\r\n-        selectedProducts: promo.selectedProducts\r\n-      });\r\n-\r\n-      console.log('Item details:', {\r\n-        id: item.id,\r\n-        productId: item.productId,\r\n-        name: item.name\r\n-      });\r\n-\r\n-      // Kiểm tra phạm vi áp dụng\r\n-      if (promo.scope === 'selected') {\r\n-        // Nếu là phạm vi selected, kiểm tra ID sản phẩm\r\n-        const productId = item.productId || item.id;\r\n-        \r\n-        if (!productId) {\r\n-          console.log('No product ID found for item');\r\n-          isApplicable = false;\r\n-        } else if (!promo.selectedProducts || !Array.isArray(promo.selectedProducts)) {\r\n-          console.log('No selected products array in promo');\r\n-          isApplicable = false;\r\n-        } else {\r\n-          isApplicable = promo.selectedProducts.includes(productId);\r\n-          console.log('Product ID check:', {\r\n-            productId,\r\n-            isInSelectedProducts: isApplicable\r\n-          });\r\n-        }\r\n-      } else if (promo.scope === 'all') {\r\n+      \r\n+      if (promo.scope === 'all') {\r\n         isApplicable = true;\r\n-        console.log('Applying to all products');\r\n+      } else if (promo.scope === 'selected' && promo.selectedProducts && promo.selectedProducts.length > 0) {\r\n+        // Kiểm tra cả id và productId\r\n+        const itemId = item.id || item.productId;\r\n+        isApplicable = itemId ? promo.selectedProducts.includes(itemId) : false;\r\n       }\r\n \r\n-      console.log('Final applicability:', {\r\n-        itemName: item.name,\r\n-        isApplicable\r\n-      });\r\n+      console.log('Checking item applicability:', { \r\n+        itemId: item.id,\r\n+        productId: item.productId,\r\n+        scope: promo.scope, \r\n+        selectedProducts: promo.selectedProducts,\r\n+        isApplicable,\r\n+        itemIdUsed: item.id || item.productId\r\n+      }); // Debug log\r\n \r\n       if (isApplicable) {\r\n         if (promo.type === 'fixed') {\r\n           itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n"
                },
                {
                    "date": 1749546745672,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,15 +73,16 @@\n       let itemDiscount = 0;\r\n \r\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       let isApplicable = false;\r\n-      \r\n-      if (promo.scope === 'all') {\r\n+\r\n+      if (promo.scope === 'selected') {\r\n+        // Chỉ áp dụng cho sản phẩm được chọn\r\n+        const productId = item.productId || item.id;\r\n+        isApplicable = productId && promo.selectedProducts?.includes(productId);\r\n+      } else if (promo.scope === 'all') {\r\n+        // Áp dụng cho tất cả sản phẩm\r\n         isApplicable = true;\r\n-      } else if (promo.scope === 'selected' && promo.selectedProducts && promo.selectedProducts.length > 0) {\r\n-        // Kiểm tra cả id và productId\r\n-        const itemId = item.id || item.productId;\r\n-        isApplicable = itemId ? promo.selectedProducts.includes(itemId) : false;\r\n       }\r\n \r\n       console.log('Checking item applicability:', { \r\n         itemId: item.id,\r\n"
                },
                {
                    "date": 1749547295958,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -75,11 +75,10 @@\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       let isApplicable = false;\r\n \r\n       if (promo.scope === 'selected') {\r\n-        // Chỉ áp dụng cho sản phẩm được chọn\r\n-        const productId = item.productId || item.id;\r\n-        isApplicable = productId && promo.selectedProducts?.includes(productId);\r\n+        // Kiểm tra theo tên sản phẩm\r\n+        isApplicable = item.name && promo.selectedProducts?.includes(item.name);\r\n       } else if (promo.scope === 'all') {\r\n         // Áp dụng cho tất cả sản phẩm\r\n         isApplicable = true;\r\n       }\r\n"
                },
                {
                    "date": 1749548659512,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -75,10 +75,11 @@\n       // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n       let isApplicable = false;\r\n \r\n       if (promo.scope === 'selected') {\r\n-        // Kiểm tra theo tên sản phẩm\r\n-        isApplicable = item.name && promo.selectedProducts?.includes(item.name);\r\n+        // Kiểm tra theo ID sản phẩm\r\n+        const productId = item.productId || item.id;\r\n+        isApplicable = productId && promo.selectedProducts?.includes(productId);\r\n       } else if (promo.scope === 'all') {\r\n         // Áp dụng cho tất cả sản phẩm\r\n         isApplicable = true;\r\n       }\r\n"
                },
                {
                    "date": 1751608889465,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -66,8 +66,30 @@\n         );\r\n       }\r\n     }\r\n \r\n+    // Tính toán tổng tiền các sản phẩm được áp dụng mã\r\n+    let applicableTotal = 0;\r\n+    cartItems.forEach((item: any) => {\r\n+      let isApplicable = false;\r\n+      if (promo.scope === 'selected') {\r\n+        const productId = item.productId || item.id;\r\n+        isApplicable = productId && promo.selectedProducts?.includes(productId);\r\n+      } else if (promo.scope === 'all') {\r\n+        isApplicable = true;\r\n+      }\r\n+      if (isApplicable) {\r\n+        applicableTotal += item.price * item.quantity;\r\n+      }\r\n+    });\r\n+    // Kiểm tra giá trị đơn hàng tối thiểu\r\n+    if (promo.minOrderAmount && applicableTotal < promo.minOrderAmount) {\r\n+      return NextResponse.json(\r\n+        { ok: false, message: `Đơn hàng của bạn chưa đủ giá trị tối thiểu (${promo.minOrderAmount.toLocaleString('vi-VN')} VND) để sử dụng mã giảm giá này` },\r\n+        { status: 400 }\r\n+      );\r\n+    }\r\n+\r\n     // Tính toán giảm giá cho từng sản phẩm\r\n     let totalDiscount = 0;\r\n     const updatedCartItems = cartItems.map((item: any) => {\r\n       let itemDiscount = 0;\r\n"
                }
            ],
            "date": 1749534526144,
            "name": "Commit-0",
            "content": "import { NextRequest, NextResponse } from 'next/server';\r\nimport { getServerSession } from 'next-auth';\r\nimport { authOptions } from '@/lib/auth';\r\nimport { connectToDatabase } from '@/lib/mongodb';\r\nimport { ObjectId } from 'mongodb';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n    const { db } = await connectToDatabase();\r\n    const { promoCode, cartItems } = await request.json();\r\n\r\n    if (!promoCode || !cartItems || !Array.isArray(cartItems)) {\r\n      return NextResponse.json(\r\n        { ok: false, message: 'Invalid request data' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Tìm mã giảm giá\r\n    const promo = await db.collection('promoCodes').findOne({ code: promoCode });\r\n\r\n    if (!promo) {\r\n      return NextResponse.json(\r\n        { ok: false, message: 'Mã giảm giá không tồn tại' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (!promo.isActive) {\r\n      return NextResponse.json(\r\n        { ok: false, message: 'Mã giảm giá đã bị vô hiệu hóa' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Kiểm tra ngày hết hạn\r\n    if (promo.expiryDate && new Date() > new Date(promo.expiryDate)) {\r\n      return NextResponse.json(\r\n        { ok: false, message: 'Mã giảm giá đã hết hạn' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Kiểm tra yêu cầu đăng nhập\r\n    if (promo.isLoginRequired && !session?.user?.email) {\r\n      return NextResponse.json(\r\n        { ok: false, message: 'Vui lòng đăng nhập để sử dụng mã giảm giá này' },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Kiểm tra giới hạn sử dụng cho mỗi người dùng\r\n    if (promo.isLoginRequired && session?.user?.email && promo.perUserLimit > 0) {\r\n      const userUsageCount = promo.usedByUsers?.filter(\r\n        (user: { email: string; count: number }) => user.email === session.user.email\r\n      ).reduce((total: number, user: { count: number }) => total + user.count, 0) || 0;\r\n\r\n      if (userUsageCount >= promo.perUserLimit) {\r\n        return NextResponse.json(\r\n          { ok: false, message: 'Bạn đã sử dụng hết số lần cho phép của mã giảm giá này' },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Tính toán giảm giá cho từng sản phẩm\r\n    let totalDiscount = 0;\r\n    const updatedCartItems = cartItems.map((item: any) => {\r\n      let itemDiscount = 0;\r\n\r\n      // Kiểm tra xem sản phẩm có được áp dụng mã giảm giá không\r\n      if (promo.scope === 'all' || (promo.scope === 'selected' && promo.selectedProducts?.includes(item.id))) {\r\n        if (promo.type === 'fixed') {\r\n          itemDiscount = Math.min(promo.value, item.price * item.quantity);\r\n        } else {\r\n          const percentageDiscount = (item.price * item.quantity * promo.value) / 100;\r\n          itemDiscount = promo.maxAmount \r\n            ? Math.min(percentageDiscount, promo.maxAmount)\r\n            : percentageDiscount;\r\n        }\r\n      }\r\n\r\n      totalDiscount += itemDiscount;\r\n      return {\r\n        ...item,\r\n        discount: itemDiscount\r\n      };\r\n    });\r\n\r\n    return NextResponse.json({\r\n      ok: true,\r\n      message: 'Áp dụng mã giảm giá thành công',\r\n      cartItems: updatedCartItems,\r\n      totalDiscount\r\n    });\r\n  } catch (error) {\r\n    console.error('Error applying promo code:', error);\r\n    return NextResponse.json(\r\n      { ok: false, message: 'Failed to apply promo code' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n} "
        }
    ]
}